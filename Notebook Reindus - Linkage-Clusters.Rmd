
---
title: "Notebook réindustrialisation"
author: "Alexandre BOURGEOIS"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Vignette Title}
%\VignetteEngine{knitr::rmarkdown}
\usepackage[utf8]{inputenc}
---

**Loading of packages and global parameters**

```{r setup, include=FALSE}
# Display of the code ?
knitr::opts_chunk$set(echo = TRUE) 

# Chargement des packages, chemins d'accès et quelques fonctions utiles
#source("Reindus loading.R")

# chargement des fonctions spécifiques au sujet réindus
#source("Reindus functions.R")
rm(list=ls())
library(microbenchmark)
library(RcppArmadillo)
library(Rcpp)
library(dplyr)
library(ggfortify)
library(dplyr)
library(stringr)
library(tidyverse)
library(readxl)
library(readODS)
library(R6)
library(tidyr)
library(writexl)
library(WriteXLS)
library(xlsx)
library(ggplot2)
library(roxygen2)
library(devtools)
library(forecast)
library(fable)
library(Metrics)
library(xts)
library(data.table)
library(Factoshiny)
library(skimr)
library(tseries)

setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")
```

############################################################################################################

Importation des BDD et statistiques descriptives

```{r stat_desc}

BASEres_LinkageBwdFwd_ECOLE<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_LinkageBwdFwd_ECOLE.rds")
BASEres_LinkageBwdFwd_A17<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_LinkageBwdFwd_A17.rds")
BASEres_LinkageBwdFwd_LRWIOD<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_LinkageBwdFwd_LRWIOD.rds")
BASEres_LinkageBwdFwd_WIOD<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_LinkageBwdFwd_WIOD.rds")
BASEres_LinkageBwdFwd_FIGARO<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_LinkageBwdFwd_FIGARO.rds")
Baseres_HEM_A17_FIGARO = readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_HEM_A17_FIGARO.rds")
Baseres_HEM_A17_WIOD = readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_HEM_A17_WIOD(1).rds")
Baseres_HEM_ECOLE = readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/RESULT_HEM_ECOLE.rds")

write.csv2(BASEres_LinkageBwdFwd_A17,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/BASEres_LinkageBwdFwd_A17.csv")
write.csv2(BASEres_LinkageBwdFwd_ECOLE,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/BASEres_LinkageBwdFwd_ECOLE.csv")
write.csv2(BASEres_LinkageBwdFwd_LRWIOD,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/BASEres_LinkageBwdFwd_LRWIOD.csv")
write.csv2(Baseres_HEM_ECOLE,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/Baseres_HEM_ECOLE.csv")
write.csv2(Baseres_HEM_A17_WIOD,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/Baseres_HEM_A17_WIOD.csv")
write.csv2(Baseres_HEM_A17_FIGARO,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/Baseres_HEM_A17_FIGARO.csv")
# setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")

BDD_bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][,link:="Bwd"]
BDD_fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][,link:="Fwd"]
echelle = "_A17"
setnames(BDD_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_bwd_fwd<-rbind(BDD_bwd,BDD_fwd)

BDD_Dom_bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_PartDOM"]][,link:="Bwd"]
BDD_Dom_fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_PartDOM"]][,link:="Fwd"]
echelle = "_A17"
setnames(BDD_Dom_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_Dom_bwd_fwd<-rbind(BDD_Dom_bwd,BDD_Dom_fwd)

BDD_A17 = merge(BDD_bwd_fwd,BDD_Dom_bwd_fwd,by = c("Lig_Country","Lig_Indus","year","link"))
BDD_A17 = BDD_A17 %>%
  mutate(valueDom = value*Part_Dom,pays_branche = paste(Lig_Country,Lig_Indus))


BDD_A17 = BDD_A17 %>%
  arrange(year,value)

cinq_max = function(annee,linkage){
  data = BDD_A17[BDD_A17$year==annee & BDD_A17$link==linkage,]
  data = data %>%
    arrange(value)
  print(c(data$pays_branche[1:5],annee,linkage))
}
for (annee in 2000:2020){
  cinq_max(annee,"Bwd")
  cinq_max(annee,"Fwd")
}
# annee = 2000
# linkage = "Bwd"
# data = BDD_A17[BDD_A17$year==annee & BDD_A17$link==linkage,]
#   data = data %>%
#   arrange(desc(value))
#   return(data[1:5,])




# data = BDD_bwd_fwd[BDD_bwd_fwd$Lig_Country==pays,]
# ggplot(data, aes(x=as.factor(year), y=value, fill=link)) +
# geom_boxplot() +
# labs(title=paste("Boxplot des indicateurs BWD et FWD par branche pour le pays",pays),x="annee", y = "Indicateurs bwd et fwd")
# BDD_bwd_fwd = BDD_bwd_fwd %>%
#   arrange(desc(value))
# BDD_couple_bwd_fwd = merge(BDD_bwd,BDD_fwd,by = c("Lig_Country","Lig_Indus","year"))
# colnames(BDD_couple_bwd_fwd) = c("Lig_Country","Lig_Indus","year","value_bwd","link.x","value_fwd","link.y")
# BDD_couple_bwd_fwd = BDD_couple_bwd_fwd[,c(-5,-7)]
BDD_bwd_fwd_essai  = BDD_A17 %>%
  group_by(year,link) %>%
  summarise(max = max(value, na.rm = TRUE),min = min(value, na.rm = TRUE),individus_a_plus_haut_linkage = pays_branche[which.max(value)],individus_a_plus_bas_linkage = pays_branche[which.min(value)],
            scnd_max = pays_branche[quantile(value,probs = 1/428)],
           max_loc = max(valueDom, na.rm = TRUE),min_loc = min(valueDom, na.rm = TRUE),individus_a_plus_haut_linkageloc = pays_branche[which.max(valueDom)],individus_a_plus_bas_linkageloc = pays_branche[which.min(valueDom)] )

# BDD_bwd_fwd_essai  = BDD_bwd_fwd %>%
#   group_by(Lig_Indus,year,link) %>%
#   summarise(avg = mean(value))

# ggplot(BDD_bwd_fwd_essai, aes(x=as.factor(year), y=, fill=link)) +
# geom_boxplot() +
# labs(title="Boxplot des indicateurs BWD et FWD par année",x="annee", y = "Indicateurs bwd et fwd")
#



ggplot(BDD_bwd_fwd_essai) +
  geom_point(
    aes(x=year, y=min_loc ,shape = link, color = individus_a_plus_bas_linkageloc)
  ) +
  labs(title="Graphique des min de linkages intérieurs par année",x="Année", y = "Indicateurs bwd et fwd")




BDD_bwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Bwd_byCountry"]][,link:="Bwd"]
BDD_fwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Fwd_byCountry"]][,link:="Fwd"]
echelle = "_ECOLE"
#setnames(BDD_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_bwd_fwd<-rbind(BDD_bwd,BDD_fwd)

BDD_bwd<-BASEres_LinkageBwdFwd_LRWIOD[["Indic_Bwd_byCountry"]][,link:="Bwd"]
BDD_fwd<-BASEres_LinkageBwdFwd_LRWIOD[["Indic_Fwd_byCountry"]][,link:="Fwd"]
BDD_fwd = subset(BDD_fwd,year<2000)
BDD_bwd = subset(BDD_bwd,year<2000)
echelle = "_LRWIOD"
setnames(BDD_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_bwd_fwd<-rbind(BDD_bwd,BDD_fwd)



#Réalisation des Boxplots 

#Bwd
bowplot_bwd_fwd_pays = function(pays){
  # setwd("C:/Users/Bendounan Adel/Documents/Pictures/sf_projetmethodo")
  data = BDD_A17[BDD_A17$Lig_Country==pays,]
  ggplot(data, aes(x=as.factor(year), y=value, fill=link)) +
  geom_boxplot() +
  labs(title=paste("Boxplot des indicateurs BWD et FWD par année pour le pays",pays),x="annee", y = "Indicateurs bwd et fwd")
  ggsave(filename = paste(paste(pays,echelle),".png"))
  #
}
for (country in levels(factor(BDD_A17$Lig_Country))){
  bowplot_bwd_fwd_pays(country)
}


  
bowplot_bwd_fwd_br = function(br){
  # setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_branche")
  data = BDD_A17[BDD_A17$Lig_Indus==br,]
  ggplot(data, aes(x=as.factor(year), y=value, fill=link)) +
  geom_boxplot() +
  labs(title=paste("Boxplot des indicateurs BWD et FWD par année pour la branche",br),x="Année", y = "Indicateur bwd et fwd")
  ggsave(filename = paste(paste(br,echelle),".png"))
  # dev.print(device = png,file = paste(br,paste(echelle,"_bwd.png")),width = 600)
}
for (branche in levels(factor(BDD_A17$Lig_Indus))){
  bowplot_bwd_fwd_br(branche)
}

#BDD de stats desc

BDD_statdesc_bwd_fwd_bycountry_A17 = BDD_bwd_fwd %>%
  group_by(Lig_Country,year,link) %>%
  summarise(missing_va = sum(is.na(value)),avg = mean(value),ecart_t = sd(value),med = median(value),minim = min(value),q1 = quantile(value,probs = 0.25),q3 = quantile(value,probs = 0.75),maxim = max(value),label_min = Lig_Indus[which.min(value)],label_2nd_min = Lig_Indus[order(value)==2],label_2nd_max = Lig_Indus[order(value,decreasing = T)==2] ,label_max = Lig_Indus[which.max(value)])
write.csv(BDD_statdesc_bwd_fwd_bycountry_ECOLE,file = paste("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country/BDD_statdesc_bwd_fwd_bycountry_ECOLE.csv"))


BDD_statdesc_bwd_fwd_byIndus_ECOLE = BDD_bwd_fwd %>%
  group_by(Lig_Indus,year,link) %>%
  summarise(missing_va = sum(is.na(value)),avg = mean(value),ecart_t = sd(value),med = median(value),minim = min(value),q1 = quantile(value,probs = 0.25),q3 = quantile(value,probs = 0.75),maxim = max(value),label_min = Lig_Country[which.min(value)],label_2nd_min = Lig_Country[order(value)==2],label_2nd_max = Lig_Country[order(value,decreasing = T)==2] ,label_max = Lig_Country[which.max(value)])
write.csv(BDD_statdesc_bwd_fwd_byIndus_ECOLE,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_branche/BDD_statdesc_bwd_fwd_byIndus_ECOLE.csv")

#Les coefficients de backward et forward sont relativement stables en moyenne
#Par conséquent, chercher à travailler de sur des axes d'un autre pays n'apporte pas d'informations  supplémentaires !

BDD_Dom_bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_PartDOM"]][,link:="Bwd"]
BDD_Dom_fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_PartDOM"]][,link:="Fwd"]
echelle = "_A17"
#setnames(BDD_Dom_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_Dom_bwd_fwd<-rbind(BDD_Dom_bwd,BDD_Dom_fwd)

BDD_Dom_bwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Bwd_PartDOM"]][,link:="Bwd"]
BDD_Dom_fwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Fwd_PartDOM"]][,link:="Fwd"]
echelle = "_ECOLE"
#setnames(BDD_Dom_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_Dom_bwd_fwd<-rbind(BDD_Dom_bwd,BDD_Dom_fwd)

BDD_Dom_bwd<-BASEres_LinkageBwdFwd_LRWIOD[["Indic_Bwd_PartDOM"]][,link:="Bwd"]
BDD_Dom_fwd<-BASEres_LinkageBwdFwd_LRWIOD[["Indic_Fwd_PartDOM"]][,link:="Fwd"]
BDD_Dom_bwd = subset(BDD_Dom_bwd,year<2000)
BDD_Dom_fwd = subset(BDD_Dom_fwd,year<2000)
echelle = "_LRWIOD"
setnames(BDD_Dom_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_Dom_bwd_fwd<-rbind(BDD_Dom_bwd,BDD_Dom_fwd)

# setnames(BDD_Dom_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# BDD_Dom_bwd_fwd<-rbind(BDD_Dom_bwd,BDD_Dom_fwd)
BDD_couple_Dom_bwd_fwd = cbind(BDD_Dom_bwd,BDD_Dom_fwd,by = c("Lig_Country","Lig_Indus","year"))


bowplot_Dom_bwd_fwd_pays = function(pays){
  setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")
  data = BDD_Dom_bwd_fwd[BDD_Dom_bwd_fwd$Lig_Country==pays,]
  ggplot(data, aes(x=Lig_Indus, y=Part_Dom, fill=link)) +
  geom_boxplot() +
  labs(title=paste("Boxplot des parts DOM des indicateurs BWD et FWD par branche pour le pays",pays),x="Branche de l'économie", y = "Part en DOM des Indicateurs bwd et fwd")
  ggsave(filename = paste(paste(pays,echelle),"_DOM.png"))
  #
}
for (country in levels(factor(BDD_bwd_fwd$Lig_Country))){
  bowplot_Dom_bwd_fwd_pays(country)
}


  
bowplot_Dom_bwd_fwd_br = function(br){
  setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_branche")
  data = BDD_Dom_bwd_fwd[BDD_Dom_bwd_fwd$Lig_Indus==br,]
  ggplot(data, aes(x=Lig_Country, y=Part_Dom, fill=link)) +
  geom_boxplot() +
  labs(title=paste("Boxplot des parts DOM des indicateurs BWD et FWD par pays pour la branche",br),x="Pays", y = "Part en DOM des Indicateurs bwd et fwd")
  ggsave(filename = paste(paste(br,echelle),"_DOM.png"))
  # dev.print(device = png,file = paste(br,paste(echelle,"_bwd.png")),width = 600)
}
for (branche in levels(factor(BDD_Dom_bwd_fwd$Lig_Indus))){
  bowplot_Dom_bwd_fwd_br(branche)
}

# plot(BDD_Dom_bwd$value ~ factor(BDD_Dom_bwd$Lig_Indus))
# plot(BDD_Dom_bwd$value ~ factor(BDD_Dom_bwd$Lig_Country))
# plot(BDD_Dom_fwd$value ~ factor(BDD_Dom_fwd$Lig_Indus))
# plot(BDD_Dom_fwd$value ~ factor(BDD_Dom_fwd$Lig_Country))

BDD_Dom_statdesc_bwd_fwd_bycountry_ECOLE = BDD_Dom_bwd_fwd %>%
  group_by(Lig_Country,year,link) %>%
  summarise(missing_va = sum(is.na(Part_Dom)),avg = mean(Part_Dom),ecart_t = sd(Part_Dom),med = median(Part_Dom),minim = min(Part_Dom),q1 = quantile(Part_Dom,probs = 0.25),q3 = quantile(Part_Dom,probs = 0.75),maxim = max(Part_Dom),label_min = Lig_Indus[which.min(Part_Dom)],label_2nd_min = Lig_Indus[order(Part_Dom)==2],label_2nd_max = Lig_Indus[order(Part_Dom,decreasing = T)==2] ,label_max = Lig_Indus[which.max(Part_Dom)])
write.csv(BDD_Dom_statdesc_bwd_fwd_bycountry_ECOLE,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country/BDD_Dom_statdesc_bwd_fwd_bycountry_ECOLE.csv")



BDD_Dom_statdesc_bwd_fwd_byIndus_ECOLE = BDD_Dom_bwd_fwd %>%
  group_by(Lig_Indus,year,link) %>%
  summarise(missing_va = sum(is.na(Part_Dom)),avg = mean(Part_Dom),ecart_t = sd(Part_Dom),med = median(Part_Dom),minim = min(Part_Dom),q1 = quantile(Part_Dom,probs = 0.25),q3 = quantile(Part_Dom,probs = 0.75),maxim = max(Part_Dom),label_min = Lig_Country[which.min(Part_Dom)],label_2nd_min = Lig_Country[order(Part_Dom)==2],label_2nd_max = Lig_Country[order(Part_Dom,decreasing = T)==2] ,label_max = Lig_Country[which.max(Part_Dom)])
write.csv(BDD_Dom_statdesc_bwd_fwd_byIndus_ECOLE,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_branche/BDD_Dom_statdesc_bwd_fwd_byIndus_ECOLE.csv")


####### HEM ###########

BDD_HEM<-Baseres_HEM_A17_FIGARO
levels(as.factor(BDD_HEM$year))


bowplot_HEM_pays = function(pays){
  # setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")
  data = BDD_HEM[BDD_HEM$Lig_Country==pays,]
  ggplot(data, aes(x=as.factor(year), y=Indic_HEM)) +
  geom_boxplot() +
  labs(title=paste("Boxplot des indicateurs HEM par année pour le pays",pays),x="année", y = "Indicateur HEM")
  ggsave(filename = paste(pays,"_FIGHEM.png"))
  # dev.print(device = png,file = paste(pays,"_hem.png"),width = 600)
}
for (country in levels(factor(BDD_HEM$Lig_Country))){
  bowplot_HEM_pays(country)
}


bowplot_HEM_br = function(br){
  setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_branche")
  data = BDD_HEM[BDD_HEM$Lig_Indus==br,]
  ggplot(data, aes(x=Lig_Country, y=Indic_HEM)) +
  geom_boxplot() +
  labs(title=paste("Boxplot des indicateurs HEM par pays pour la branche",br),x="Pays", y = "Indicateur HEM")
  ggsave(filename = paste(br,"_HEM.png"))
}
for (branche in levels(factor(BDD_HEM$Lig_Indus))){
  bowplot_HEM_br(branche)
}

# 
# plot(BDD_HEM$Indic_HEM ~ factor(BDD_HEM$Lig_Indus))
# plot(BDD_HEM$Indic_HEM ~ factor(BDD_HEM$Lig_Country))
# plot(BDD_Dom_fwd$value ~ factor(BDD_Dom_fwd$Lig_Indus))
# plot(BDD_Dom_fwd$value ~ factor(BDD_Dom_fwd$Lig_Country))

BDD_HEM_statdesc_bycountry = BDD_HEM %>%
  group_by(Lig_Country,year) %>%
  summarise(missing_va = sum(is.na(Indic_HEM)),avg = mean(Indic_HEM),ecart_t = sd(Indic_HEM),med = median(Indic_HEM),minim = min(Indic_HEM),q1 = quantile(Indic_HEM,probs = 0.25),q3 = quantile(Indic_HEM,probs = 0.75),maxim = max(Indic_HEM),label_min = Lig_Indus[which.min(Indic_HEM)],label_2nd_min = Lig_Indus[order(Indic_HEM)==2],label_2nd_max = Lig_Indus[order(Indic_HEM,decreasing = T)==2] ,label_max = Lig_Indus[which.max(Indic_HEM)])
write.csv(BDD_HEM_statdesc_bycountry,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country/BDD_HEM_statdesc_bycountry.csv")


BDD_HEM_statdesc_byIndus = BDD_HEM %>%
  group_by(Lig_Indus,year) %>%
  summarise(missing_va = sum(is.na(Indic_HEM)),avg = mean(Indic_HEM),ecart_t = sd(Indic_HEM),med = median(Indic_HEM),minim = min(Indic_HEM),q1 = quantile(Indic_HEM,probs = 0.25),q3 = quantile(Indic_HEM,probs = 0.75),maxim = max(Indic_HEM),label_min = Lig_Country[which.min(Indic_HEM)],label_2nd_min = Lig_Country[order(Indic_HEM)==2],label_2nd_max = Lig_Country[order(Indic_HEM,decreasing = T)==2] ,label_max = Lig_Country[which.max(Indic_HEM)])
write.csv(BDD_HEM_statdesc_byIndus,file = "C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_branche/BDD_HEM_statdesc_byIndus.csv")



```

```{r ts}

ts_bdd_pays_couple_bwd_fwd = function(bdd,pays){
  BDD_bwd_ts<-bdd[["Indic_Bwd_byCountry"]][,link:="Bwd"]
  BDD_fwd_ts<-bdd[["Indic_Fwd_byCountry"]][,link:="Fwd"]
  #setnames(BDD_fwd_ts,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
  #BDD_bwd_fwd_ts<-rbind(BDD_bwd_ts,BDD_fwd_ts)
  BDD_couple_bwd_fwd_ts = merge(BDD_bwd_ts,BDD_fwd_ts,by = c("Lig_Country","Lig_Indus","year"))
  colnames(BDD_couple_bwd_fwd_ts) = c("Lig_Country","Lig_Indus","year","value_bwd","link.x","value_fwd","link.y")
  BDD_couple_bwd_fwd_ts = BDD_couple_bwd_fwd_ts[,c(-5,-7)]
  bdd_selec = BDD_couple_bwd_fwd_ts %>% filter(Lig_Country == pays)
  bdd_selec = bdd_selec %>% pivot_wider(names_from = Lig_Indus, values_from = c(value_bwd,value_fwd))
  bdd_selec = bdd_selec[,-1]
  if (bdd_selec$year[1]<2000){
    bdd_selec = subset(bdd_selec,year<=2000)
    ts_bdd_selec = ts(bdd_selec[,-1],start = 1965,frequency = 1)
    autoplot(ts_bdd_selec)
  } else {
    ts_bdd_selec = ts(bdd_selec[,-1],start = 2000,frequency = 1)
    autoplot(ts_bdd_selec)
  }
}

# vecteur_bdd = c(BASEres_LinkageBwdFwd_A17,BASEres_LinkageBwdFwd_A17,
#                 BASEres_LinkageBwdFwd_A17,BASEres_LinkageBwdFwd_A17,
#                 BASEres_LinkageBwdFwd_A17)
ts_bdd_pays_couple_bwd_fwd(BASEres_LinkageBwdFwd_LRWIOD,"FRA")


#   library(vars)
#   mod = VARselect(ts_bdd_selec,lag.max = 5)
#   mod$selection
#   varp_best.fit = VAR(ts_bdd_selec, p=1, type = "none")
#   
#   roots(varp_best.fit,modulus=TRUE) 
#   summary(varp_best.fit)
# irf1 = irf(varp_best.fit, impulse = "value_bwd_AZ", response = "value_bwd_C1", n.ahead = 5, boot = TRUE, ci=0,95)
# plot(irf1, ylab = "y1", main = "essai")

  
```


PARTIE LINKAGE

############################################################################################################

A faire:
- Branches économiques qui se distinguent au sein du territoire francais (2019,2014,2009,2004)
- Pareil avec les autres pays (2019,2014)
- Parmi les branches qui se distinguent, comparaison entre pays et sur le temps !

Croisement Bwd et Fwd sur 2019 (base A17)

```{r}
# Chargement des résultats sur les linkage backward et forward

BASEres_LinkageBwdFwd_ECOLE<-readRDS("C:/Users/rayab/OneDrive/Bureau/ENSAI 3A/projet/new/nouvelles_donnees/RESULT_LinkageBwdFwd_ECOLE.rds")
BASEres_LinkageBwdFwd_A17<-readRDS("C:/Users/rayab/OneDrive/Bureau/ENSAI 3A/projet/new/nouvelles_donnees/RESULT_LinkageBwdFwd_A17.rds")
BASEres_LinkageBwdFwd_LRWIOD<-readRDS("C:/Users/rayab/OneDrive/Bureau/ENSAI 3A/projet/new/nouvelles_donnees/RESULT_LinkageBwdFwd_LRWIOD.rds")
```



Croisement Bwd et Fwd sur 2019 (base A17)

```{r}
auto_croisementbwdfwd <- function(pays, annee){
  
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)
LinkageBwdFwd_A17_tab$cluster <- res.km$cluster

p<-ggplot(LinkageBwdFwd_A17_tab, aes(x=Bwd, y=Fwd, col = factor(cluster))) +
  geom_point(size = 2, alpha = 0.8, position = "jitter") + # Show dots
  geom_label(
    label=LinkageBwdFwd_A17_tab$Lig_Indus, 
    nudge_x = 0.005, nudge_y = 0.005, 
    check_overlap = T
  )
p+geom_hline(data=LinkageBwdFwd_A17_tab,yintercept=mean(LinkageBwdFwd_A17_tab$Fwd))+geom_vline(data=LinkageBwdFwd_A17_tab,xintercept=mean(LinkageBwdFwd_A17_tab$Bwd))+labs(color = "Cluster de l'année demandée") +ggtitle(c(pays,annee))
  
}

```


Croisements sur plusieurs pays et années
liste des pays : AUS AUT BEL BRA CAN CHN DEU DNK ESP FIN FRA GBR GRC IND IRL ITA JPN KOR MEX NLD PRT ROW SWE USA 
```{r}
auto_croisementbwdfwd("AUS", 2019)
auto_croisementbwdfwd("AUT", 2019)
auto_croisementbwdfwd("BEL", 2019)
auto_croisementbwdfwd("BRA", 2019)
auto_croisementbwdfwd("CAN", 2019)
auto_croisementbwdfwd("CHN", 2019)
auto_croisementbwdfwd("DEU", 2019)
auto_croisementbwdfwd("DNK", 2019)
auto_croisementbwdfwd("ESP", 2019)
auto_croisementbwdfwd("FIN", 2019)
auto_croisementbwdfwd("FRA", 2019)
auto_croisementbwdfwd("GBR", 2019)
auto_croisementbwdfwd("GRC", 2019)
auto_croisementbwdfwd("IND", 2019)
auto_croisementbwdfwd("IRL", 2019)
auto_croisementbwdfwd("ITA", 2019)
auto_croisementbwdfwd("JPN", 2019)
auto_croisementbwdfwd("KOR", 2019)
auto_croisementbwdfwd("MEX", 2019)
auto_croisementbwdfwd("NLD", 2019)
auto_croisementbwdfwd("PRT", 2019)
auto_croisementbwdfwd("ROW", 2019)
auto_croisementbwdfwd("SWE", 2019)
auto_croisementbwdfwd("USA", 2019)
```

```{r}
auto_croisementbwdfwddom <- function(pays, annee){
  
BDD_bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
BDD_fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
setnames(BDD_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_bwd_fwd<-rbind(BDD_bwd,BDD_fwd)

BDD_Dom_bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_PartDOM"]][Col_Country==pays & year==annee,][,link:="Bwd"]
BDD_Dom_fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_PartDOM"]][Lig_Country==pays & year==annee,][,link:="Fwd"]
setnames(BDD_Dom_bwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
BDD_Dom_bwd_fwd<-rbind(BDD_Dom_bwd,BDD_Dom_fwd)

BDD_A17 = merge(BDD_bwd_fwd,BDD_Dom_bwd_fwd,by = c("Lig_Country","Lig_Indus","year","link"))
BDD_A17 = BDD_A17 %>%
  mutate(valueDom = value*Part_Dom)
  
BDD_A17_tab<-dcast(BDD_A17,Lig_Indus ~ link,value.var="valueDom")

res.km <- kmeans(scale(BDD_A17_tab[,c(2:3)]), 4, nstart = 10)
BDD_A17_tab$cluster <- res.km$cluster

p<-ggplot(BDD_A17_tab, aes(x=Bwd, y=Fwd, col = factor(cluster))) +
  geom_point(size = 2, alpha = 0.8, position = "jitter") + # Show dots
  geom_label(
    label=BDD_A17_tab$Lig_Indus, 
    nudge_x = 0.005, nudge_y = 0.005, 
    check_overlap = T
  )
p+geom_hline(data=BDD_A17_tab,yintercept=mean(BDD_A17_tab$Fwd))+geom_vline(data=BDD_A17_tab,xintercept=mean(BDD_A17_tab$Bwd))+labs(color = "Cluster de l'année demandée") +ggtitle(c(pays,annee))
  
}

```

```{r}
auto_croisementbwdfwddom("FRA", 2019)
auto_croisementbwdfwd("FRA", 2019)

```


```{r}
#l'année de reference est celui avec lequel on va comparer
auto_croisementbwdfwdcomparaison <- function(pays, annee_ref, annee){
  
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

#année de ref
LinkageBwdFwd_A17_Bwd_ref<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee_ref,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd_ref<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee_ref,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd_ref,c("Col_Country","Col_Indus"),c("Lig_Country_ref","Lig_Indus_ref"))
setnames(LinkageBwdFwd_A17_Bwd_ref,c("Lig_Country","Lig_Indus"),c("Lig_Country_ref","Lig_Indus_ref"))
LinkageBwdFwd_A17_ref<-rbind(LinkageBwdFwd_A17_Bwd_ref,LinkageBwdFwd_A17_Fwd_ref)

LinkageBwdFwd_A17_tab_ref<-dcast(LinkageBwdFwd_A17_ref,Lig_Indus_ref ~ link,value.var="value")
setnames(LinkageBwdFwd_A17_tab_ref, c("Bwd","Fwd"), c("Bwd_ref","Fwd_ref"))


LinkageBwdFwd_A17_tab <- cbind(LinkageBwdFwd_A17_tab, LinkageBwdFwd_A17_tab_ref)

res.kmr <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(5:6)]), 4, nstart = 10)
LinkageBwdFwd_A17_tab$cluster_ref <- res.kmr$cluster

res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]),centers = res.kmr$centers, 4, nstart = 10)
LinkageBwdFwd_A17_tab$cluster <- res.km$cluster

p<-ggplot(LinkageBwdFwd_A17_tab, aes(x=Bwd, y=Fwd, col = factor(cluster), shape = factor(cluster_ref))) +
  geom_point(size = 2, alpha = 0.8, position = "jitter") + # Show dots
  geom_label(
    label=LinkageBwdFwd_A17_tab$Lig_Indus, 
    nudge_x = 0.005, nudge_y = 0.005, 
    check_overlap = T
  )
p+geom_hline(yintercept=mean(LinkageBwdFwd_A17_tab$Fwd))+geom_vline(xintercept=mean(LinkageBwdFwd_A17_tab$Bwd))+ labs(color = "Cluster de l'année demandée")+ labs(shape = "Cluster de l'année de référence")+ggtitle(c(pays,annee))
  
}

```
```{r}
auto_croisementbwdfwdcomparaison("AUS", 2014, 2019)
auto_croisementbwdfwdcomparaison("AUT", 2014, 2019)
auto_croisementbwdfwdcomparaison("BEL", 2014, 2019)
auto_croisementbwdfwdcomparaison("BRA", 2014, 2019)
auto_croisementbwdfwdcomparaison("CAN", 2014, 2019)
auto_croisementbwdfwdcomparaison("CHN", 2014, 2019)
auto_croisementbwdfwdcomparaison("DEU", 2014, 2019)
auto_croisementbwdfwdcomparaison("DNK", 2014, 2019)
auto_croisementbwdfwdcomparaison("ESP", 2014, 2019)
auto_croisementbwdfwdcomparaison("FIN", 2014, 2019)
auto_croisementbwdfwdcomparaison("FRA", 2014, 2019)

auto_croisementbwdfwdcomparaison("FRA", 2004, 2014)

auto_croisementbwdfwdcomparaison("GBR", 2014, 2019)
auto_croisementbwdfwdcomparaison("GRC", 2014, 2019)
auto_croisementbwdfwdcomparaison("IND", 2014, 2019)
auto_croisementbwdfwdcomparaison("IRL", 2014, 2019)
auto_croisementbwdfwdcomparaison("ITA", 2014, 2019)
auto_croisementbwdfwdcomparaison("JPN", 2014, 2019)
auto_croisementbwdfwdcomparaison("KOR", 2014, 2019)
auto_croisementbwdfwdcomparaison("MEX", 2014, 2019)
auto_croisementbwdfwdcomparaison("NLD", 2014, 2019)
auto_croisementbwdfwdcomparaison("PRT", 2014, 2019)
auto_croisementbwdfwdcomparaison("ROW", 2014, 2019)
auto_croisementbwdfwdcomparaison("SWE", 2014, 2019)
auto_croisementbwdfwdcomparaison("USA", 2014, 2019)

```

```{r}
########################### Croisement Bwd et Fwd sur 2019 (base A17)

# auto_croisementbwdfwd <- function(pays,annee){
#   LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
#   LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
#   setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
#   LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)
#   LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")
# 
#   res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)
#   LinkageBwdFwd_A17_tab$cluster <- res.km$cluster
# 
#   p<-ggplot(LinkageBwdFwd_A17_tab, aes(x=Bwd, y=Fwd, col = factor(cluster))) +
#   geom_point(size = 2, alpha = 0.8, position = "jitter") + # Show dots
#   geom_label(
#     label=LinkageBwdFwd_A17_tab$Lig_Indus,
#     nudge_x = 0.005, nudge_y = 0.005,
#     check_overlap = T
#   )
#   p+geom_hline(data=LinkageBwdFwd_A17_tab,yintercept=mean(LinkageBwdFwd_A17_tab$Fwd))+geom_vline(data=LinkageBwdFwd_A17_tab,xintercept=mean(LinkageBwdFwd_A17_tab$Bwd))
# }
# auto_croisementbwdfwd("FRA","2009")
# auto_croisementbwdfwd("FRA","2004")
# 
# auto_croisementbwdfwd("MEX","2019")
# auto_croisementbwdfwd("MEX","2014")
# auto_croisementbwdfwd("MEX","2009")
# auto_croisementbwdfwd("MEX","2004")
# 
# #Croisement France année 2019
# 
# LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA" & year=="2019",][,link:="Bwd"]
# LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country=="FRA" & year=="2019",][,link:="Fwd"]
# setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)
# 
# LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")
# 
# p<-ggplot(LinkageBwdFwd_A17_tab, aes(x=Bwd, y=Fwd)) +
#   geom_point() + # Show dots
#   geom_label(
#     label=LinkageBwdFwd_A17_tab$Lig_Indus,
#     nudge_x = 0.005, nudge_y = 0.005,
#     check_overlap = T
#   )
# p+geom_hline(data=LinkageBwdFwd_A17_tab,yintercept=mean(LinkageBwdFwd_A17_tab$Fwd))+geom_vline(data=LinkageBwdFwd_A17_tab,xintercept=mean(LinkageBwdFwd_A17_tab$Bwd))
# 
# croisement_BwdFwd_pays_annee = function(pays,annee){
#   LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
# LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
# setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)
# 
# LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")
# 
# p<-ggplot(LinkageBwdFwd_A17_tab, aes(x=Bwd, y=Fwd)) +
#   geom_point() + # Show dots
#   geom_label(
#     label=LinkageBwdFwd_A17_tab$Lig_Indus,
#     nudge_x = 0.005, nudge_y = 0.005,
#     check_overlap = T
#   )
# p+geom_hline(data=LinkageBwdFwd_A17_tab,yintercept=mean(LinkageBwdFwd_A17_tab$Fwd))+geom_vline(data=LinkageBwdFwd_A17_tab,xintercept=mean(LinkageBwdFwd_A17_tab$Bwd))
# }
# 
# croisement_BwdFwd_pays_annee("FRA",2019)
# croisement_BwdFwd_pays_annee("FRA",2014)
# croisement_BwdFwd_pays_annee("FRA",2009)
# croisement_BwdFwd_pays_annee("FRA",2004)
# 
# croisement_BwdFwd_pays_annee("MEX",2019)
# croisement_BwdFwd_pays_annee("MEX",2014)
# croisement_BwdFwd_pays_annee("MEX",2009)
# croisement_BwdFwd_pays_annee("MEX",2004)
# 
# # croisement_BwdFwd_pays_annee("USA",2019)
# # croisement_BwdFwd_pays_annee("USA",2014)
# # croisement_BwdFwd_pays_annee("USA",2009)
# # croisement_BwdFwd_pays_annee("USA",2004)
# #
# # croisement_BwdFwd_pays_annee("CHN",2019)
# # croisement_BwdFwd_pays_annee("CHN",2014)
# # croisement_BwdFwd_pays_annee("CHN",2009)
# # croisement_BwdFwd_pays_annee("CHN",2004)
```

```{r essai Adel +}
# 
# LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA" & year=="2019",][,link:="Bwd"]
# LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Lig_Country=="FRA" & year=="2019",][,link:="Fwd"]
# #setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)
# LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")
# 
# LinkageBwdFwd_A17_Bwd_ref<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="MEX" & year=="2019",][,link:="Bwd"]
# LinkageBwdFwd_A17_Fwd_ref<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Lig_Country=="MEX" & year=="2019",][,link:="Fwd"]
# #setnames(LinkageBwdFwd_A17_Fwd_ref,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# LinkageBwdFwd_A17_ref<-rbind(LinkageBwdFwd_A17_Bwd_ref,LinkageBwdFwd_A17_Fwd_ref)
# LinkageBwdFwd_A17_ref_tab<-dcast(LinkageBwdFwd_A17_ref,Lig_Indus ~ link,value.var="value")
# 
# 
# res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)
# LinkageBwdFwd_A17_tab$cluster <- res.km$cluster
# 
# print(c("Voici les moyennes des fwd et bwd du pays choisi:",median(LinkageBwdFwd_A17_tab$Fwd),median(LinkageBwdFwd_A17_tab$Bwd)))
# print(c("Voici les moyennes des fwd et bwd du pays de référence choisi:",median(LinkageBwdFwd_A17_ref_tab$Fwd),median(LinkageBwdFwd_A17_ref_tab$Bwd)))
# 
# p<-ggplot(LinkageBwdFwd_A17_tab, aes(x=Bwd, y=Fwd, col = factor(cluster))) +
#   geom_point(size = 2, alpha = 0.8, position = "jitter") + # Show dots
#   geom_label(
#     label=LinkageBwdFwd_A17_tab$Lig_Indus, 
#     nudge_x = 0.005, nudge_y = 0.005, 
#     check_overlap = T
#   )
# p+geom_hline(data=LinkageBwdFwd_A17_ref_tab,yintercept=mean(LinkageBwdFwd_A17_ref_tab$Fwd))+geom_vline(data=LinkageBwdFwd_A17_tab,xintercept=mean(LinkageBwdFwd_A17_ref_tab$Bwd))
# ```

# Linkage : partie graphs temporels

```{r}

########################### Graphs temporels

# Exploitation des bases : BASEres_LinkageBwdFwd_ECOLE ; BASEres_LinkageBwdFwd_A17 ; BASEres_LinkageBwdFwd_LRWIO 

#### Backward linkage sur base A17
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA" & year==2019,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country=="FRA" & year==2019,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)
LinkageBwdFwd_A17_tab$cluster <- res.km$cluster

LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA",]
  
LinkageBwdFwd_A17_Bwd_tab<-dcast(LinkageBwdFwd_A17_Bwd,Lig_Indus ~ year ,value.var="value") 
LinkageBwdFwd_A17_Bwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Bwd_tab))
colnames(LinkageBwdFwd_A17_Bwd_ttab)<-LinkageBwdFwd_A17_Bwd_ttab[1,]
LinkageBwdFwd_A17_Bwd_ttab<-LinkageBwdFwd_A17_Bwd_ttab[-1,]
LinkageBwdFwd_A17_Bwd_ttab<-setDF(LinkageBwdFwd_A17_Bwd_ttab)
LinkageBwdFwd_A17_Bwd_ttab<- mutate_all(LinkageBwdFwd_A17_Bwd_ttab, function(x) as.numeric(as.character(x)))

shape=c(0:2,3,5,15,17:19)

List_BR<-colnames(LinkageBwdFwd_A17_Bwd_ttab)[2:18]
matplot(LinkageBwdFwd_A17_Bwd_ttab$Lig_Indus, LinkageBwdFwd_A17_Bwd_ttab[,2:18],type="b",col= factor(LinkageBwdFwd_A17_tab$cluster),pch = shape, xlab="années",ylab="Indic linkage",main="Backward Linkage du pays au format A17")
legend(x="bottomleft", legend=List_BR, pch = shape) 
options(repr.plot.width=20, repr.plot.height=10)

LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA" & year==2019,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country=="FRA" & year==2019,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.kmr <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)

cluster_annee <- function(pays,annee,res.kmr){
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4,centers = res.kmr$centers, nstart = 10)
d <- data.frame(res.km$cluster) 
colnames(d) <- annee
d
}

cluster_pays_annee <- cluster_annee("FRA", 2000, res.kmr)
cluster_pays_annee$annee2001 <- cluster_annee("FRA", 2001, res.kmr)
cluster_pays_annee$annee2002 <- cluster_annee("FRA", 2002, res.kmr)
cluster_pays_annee$annee2003 <- cluster_annee("FRA", 2003, res.kmr)
cluster_pays_annee$annee2004 <- cluster_annee("FRA", 2004, res.kmr)
cluster_pays_annee$annee2005 <- cluster_annee("FRA", 2005, res.kmr)
cluster_pays_annee$annee2006 <- cluster_annee("FRA", 2006, res.kmr)
cluster_pays_annee$annee2007 <- cluster_annee("FRA", 2007, res.kmr)
cluster_pays_annee$annee2008 <- cluster_annee("FRA", 2008, res.kmr)
cluster_pays_annee$annee2009 <- cluster_annee("FRA", 2009, res.kmr)
cluster_pays_annee$annee2010 <- cluster_annee("FRA", 2010, res.kmr)
cluster_pays_annee$annee2011 <- cluster_annee("FRA", 2011, res.kmr)
cluster_pays_annee$annee2012 <- cluster_annee("FRA", 2012, res.kmr)
cluster_pays_annee$annee2013 <- cluster_annee("FRA", 2013, res.kmr)
cluster_pays_annee$annee2014 <- cluster_annee("FRA", 2014, res.kmr)
cluster_pays_annee$annee2015 <- cluster_annee("FRA", 2015, res.kmr)
cluster_pays_annee$annee2016 <- cluster_annee("FRA", 2016, res.kmr)
cluster_pays_annee$annee2017 <- cluster_annee("FRA", 2017, res.kmr)
cluster_pays_annee$annee2018 <- cluster_annee("FRA", 2018, res.kmr)
cluster_pays_annee$annee2019 <- cluster_annee("FRA", 2019, res.kmr)
cluster_pays_annee$annee2020 <- cluster_annee("FRA", 2020, res.kmr)



plot(LinkageBwdFwd_A17_Bwd_ttab[,1],LinkageBwdFwd_A17_Bwd_ttab[,2], xlab="Années",ylab="Indic linkage 1/2",main="Backward Linkage du pays au format A17", type = "b", frame = FALSE, pch = shape[1], col = data.frame(t(cluster_pays_annee[1,]))$X1, ylim = c(0.005,0.13))
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,3],pch = shape[2], col = data.frame(t(cluster_pays_annee[2,]))$X2 , type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,4],pch = shape[3], col = data.frame(t(cluster_pays_annee[3,]))$X3, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,5],pch = shape[4], col = data.frame(t(cluster_pays_annee[4,]))$X4, type = "b", lty  =2)


lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,6],pch = shape[5], col = data.frame(t(cluster_pays_annee[5,]))$X5, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,7],pch = shape[6], col =data.frame(t(cluster_pays_annee[6,]))$X6, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,8],pch = shape[7], col = data.frame(t(cluster_pays_annee[7,]))$X7, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,9],pch = shape[8], col = data.frame(t(cluster_pays_annee[8,]))$X8, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,10],pch = shape[9], col =data.frame(t(cluster_pays_annee[9,]))$X9, type = "b", lty  =2)
legend(x = "bottomright", horiz = TRUE,legend = List_BR[1:9], pch = shape)

plot(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,11], xlab="Années",ylab="Indic linkage 2/2",main="Backward Linkage du pays au format A17",pch = shape[1], col = data.frame(t(cluster_pays_annee[10,]))$X10, type = "b", frame = FALSE,  ylim = c(0.005,0.13))
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,12],pch = shape[2], col = data.frame(t(cluster_pays_annee[11,]))$X11, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,13],pch = shape[3], col = data.frame(t(cluster_pays_annee[12,]))$X12, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,14],pch = shape[4], col = data.frame(t(cluster_pays_annee[13,]))$X13, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,15],pch = shape[5], col = data.frame(t(cluster_pays_annee[14,]))$X14, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,16],pch = shape[6], col =data.frame(t(cluster_pays_annee[15,]))$X15, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,17],pch = shape[7], col = data.frame(t(cluster_pays_annee[16,]))$X16, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,18],pch = shape[8], col =data.frame(t(cluster_pays_annee[17,]))$X17, type = "b", lty  =2)
legend(x = "topright", horiz = TRUE, legend = List_BR[10:17], pch = shape[1:8])


#### Forward linkage sur base A17
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country=="FRA",]
  
LinkageBwdFwd_A17_Fwd_tab<-dcast(LinkageBwdFwd_A17_Fwd,Col_Indus ~ year ,value.var="value") 
LinkageBwdFwd_A17_Fwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Fwd_tab))
colnames(LinkageBwdFwd_A17_Fwd_ttab)<-LinkageBwdFwd_A17_Fwd_ttab[1,]
LinkageBwdFwd_A17_Fwd_ttab<-LinkageBwdFwd_A17_Fwd_ttab[-1,]
LinkageBwdFwd_A17_Fwd_ttab<-setDF(LinkageBwdFwd_A17_Fwd_ttab)
LinkageBwdFwd_A17_Fwd_ttab<- mutate_all(LinkageBwdFwd_A17_Fwd_ttab, function(x) as.numeric(as.character(x)))

List_BR<-colnames(LinkageBwdFwd_A17_Fwd_ttab)[2:18]
matplot(LinkageBwdFwd_A17_Fwd_ttab$Col_Indus, LinkageBwdFwd_A17_Fwd_ttab[,2:18],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main="Forward Linkage de la France au format A17")
legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))


#### Backward linkage sur base ECOLE et sur toute la période
LinkageBwdFwd_ECOLE_Bwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Bwd_byCountry"]][Lig_Country=="FRA",]
  
LinkageBwdFwd_ECOLE_Bwd_tab<-dcast(LinkageBwdFwd_ECOLE_Bwd,Lig_Indus ~ year ,value.var="value") 
LinkageBwdFwd_ECOLE_Bwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_ECOLE_Bwd_tab))
colnames(LinkageBwdFwd_ECOLE_Bwd_ttab)<-LinkageBwdFwd_ECOLE_Bwd_ttab[1,]
LinkageBwdFwd_ECOLE_Bwd_ttab<-LinkageBwdFwd_ECOLE_Bwd_ttab[-1,]
LinkageBwdFwd_ECOLE_Bwd_ttab<-setDF(LinkageBwdFwd_ECOLE_Bwd_ttab)
LinkageBwdFwd_ECOLE_Bwd_ttab<- mutate_all(LinkageBwdFwd_ECOLE_Bwd_ttab, function(x) as.numeric(as.character(x)))

List_BR<-colnames(LinkageBwdFwd_ECOLE_Bwd_ttab)[2:5]
matplot(LinkageBwdFwd_ECOLE_Bwd_ttab$Lig_Indus, LinkageBwdFwd_ECOLE_Bwd_ttab[,2:5],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main="Backward Linkage de la France au format ECOLE")
legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))
```

Automatisation 

```{r}
#fonction pour avoir les clusters avec des centres de reference
cluster_annee <- function(pays,annee,res.kmr){
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4,centers = res.kmr$centers, nstart = 10)
d <- data.frame(res.km$cluster) 
colnames(d) <- annee
d
}

#clusters sur toutes les annees
clusters_p_a <- function(pays, res.kmr){
cluster_pays_annee <- cluster_annee(pays, 2000, res.kmr)
cluster_pays_annee$annee2001 <- cluster_annee(pays, 2001, res.kmr)
cluster_pays_annee$annee2002 <- cluster_annee(pays, 2002, res.kmr)
cluster_pays_annee$annee2003 <- cluster_annee(pays, 2003, res.kmr)
cluster_pays_annee$annee2004 <- cluster_annee(pays, 2004, res.kmr)
cluster_pays_annee$annee2005 <- cluster_annee(pays, 2005, res.kmr)
cluster_pays_annee$annee2006 <- cluster_annee(pays, 2006, res.kmr)
cluster_pays_annee$annee2007 <- cluster_annee(pays, 2007, res.kmr)
cluster_pays_annee$annee2008 <- cluster_annee(pays, 2008, res.kmr)
cluster_pays_annee$annee2009 <- cluster_annee(pays, 2009, res.kmr)
cluster_pays_annee$annee2010 <- cluster_annee(pays, 2010, res.kmr)
cluster_pays_annee$annee2011 <- cluster_annee(pays, 2011, res.kmr)
cluster_pays_annee$annee2012 <- cluster_annee(pays, 2012, res.kmr)
cluster_pays_annee$annee2013 <- cluster_annee(pays, 2013, res.kmr)
cluster_pays_annee$annee2014 <- cluster_annee(pays, 2014, res.kmr)
cluster_pays_annee$annee2015 <- cluster_annee(pays, 2015, res.kmr)
cluster_pays_annee$annee2016 <- cluster_annee(pays, 2016, res.kmr)
cluster_pays_annee$annee2017 <- cluster_annee(pays, 2017, res.kmr)
cluster_pays_annee$annee2018 <- cluster_annee(pays, 2018, res.kmr)
cluster_pays_annee$annee2019 <- cluster_annee(pays, 2019, res.kmr)
cluster_pays_annee$annee2020 <- cluster_annee(pays, 2020, res.kmr)
cluster_pays_annee
}
```

```{r}

#### Backward linkage sur base A17
auto_bwdtemp <- function(pays, annee_ref){

#On recupère les centres des kmeans sur l'annee de reference
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee_ref,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee_ref,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.kmr <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)

#linkages bwd
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays,]
  
LinkageBwdFwd_A17_Bwd_tab<-dcast(LinkageBwdFwd_A17_Bwd,Lig_Indus ~ year ,value.var="value") 
LinkageBwdFwd_A17_Bwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Bwd_tab))
colnames(LinkageBwdFwd_A17_Bwd_ttab)<-LinkageBwdFwd_A17_Bwd_ttab[1,]
LinkageBwdFwd_A17_Bwd_ttab<-LinkageBwdFwd_A17_Bwd_ttab[-1,]
LinkageBwdFwd_A17_Bwd_ttab<-setDF(LinkageBwdFwd_A17_Bwd_ttab)
LinkageBwdFwd_A17_Bwd_ttab<- mutate_all(LinkageBwdFwd_A17_Bwd_ttab, function(x) as.numeric(as.character(x)))

#clusters sur toutes les annees
clusters_pays_a <- clusters_p_a(pays, res.kmr)

#forme des points
shape=c(0:2,3,5,15,17:19)
#liste des indicateurs
List_BR<-colnames(LinkageBwdFwd_A17_Bwd_ttab)[2:18]

#plot de la premiere moitie des indicateurs de linkage
plot(LinkageBwdFwd_A17_Bwd_ttab[,1],LinkageBwdFwd_A17_Bwd_ttab[,2], xlab=c("Années", pays),ylab="Indic linkage 1/2",main="Backward Linkage du pays au format A17", type = "b", frame = FALSE, pch = shape[1], col = data.frame(t(cluster_pays_annee[1,]))$X1, ylim = c(-0.02,0.13))
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,3],pch = shape[2], col = data.frame(t(cluster_pays_annee[2,]))$X2 , type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,4],pch = shape[3], col = data.frame(t(cluster_pays_annee[3,]))$X3, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,5],pch = shape[4], col = data.frame(t(cluster_pays_annee[4,]))$X4, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,6],pch = shape[5], col = data.frame(t(cluster_pays_annee[5,]))$X5, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,7],pch = shape[6], col =data.frame(t(cluster_pays_annee[6,]))$X6, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,8],pch = shape[7], col = data.frame(t(cluster_pays_annee[7,]))$X7, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,9],pch = shape[8], col = data.frame(t(cluster_pays_annee[8,]))$X8, type = "b", lty  =2)

lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,10],pch = shape[9], col =data.frame(t(cluster_pays_annee[9,]))$X9, type = "b", lty  =2)
legend(x = "bottomright", horiz = TRUE,legend = List_BR[1:9], pch = shape)

#plot de la deuxieme moitie des indicateurs de linkage
plot(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,11], xlab=c("Années", pays),ylab="Indic linkage 2/2",main="Backward Linkage du pays au format A17",pch = shape[1], col = data.frame(t(cluster_pays_annee[10,]))$X10, type = "b", frame = FALSE,  ylim = c(-0.02,0.13))
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,12],pch = shape[2], col = data.frame(t(cluster_pays_annee[11,]))$X11, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,13],pch = shape[3], col = data.frame(t(cluster_pays_annee[12,]))$X12, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,14],pch = shape[4], col = data.frame(t(cluster_pays_annee[13,]))$X13, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,15],pch = shape[5], col = data.frame(t(cluster_pays_annee[14,]))$X14, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,16],pch = shape[6], col =data.frame(t(cluster_pays_annee[15,]))$X15, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,17],pch = shape[7], col = data.frame(t(cluster_pays_annee[16,]))$X16, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Bwd_ttab[,1], LinkageBwdFwd_A17_Bwd_ttab[,18],pch = shape[8], col =data.frame(t(cluster_pays_annee[17,]))$X17, type = "b", lty  =2)
legend(x = "topright", horiz = TRUE, legend = List_BR[10:17], pch = shape[1:8])
}
```


```{r}
auto_bwdtemp("FRA",2019)
```
Tous les pays
```{r}
auto_bwdtemp("AUS", 2019)
auto_bwdtemp("AUT", 2019)
auto_bwdtemp("BEL", 2019)
auto_bwdtemp("BRA", 2019)
auto_bwdtemp("CAN", 2019)
auto_bwdtemp("CHN", 2019)
auto_bwdtemp("DEU", 2019)
auto_bwdtemp("DNK", 2019)
auto_bwdtemp("ESP", 2019)
auto_bwdtemp("FIN", 2019)
auto_bwdtemp("FRA", 2019)
auto_bwdtemp("GBR", 2019)
auto_bwdtemp("GRC", 2019)
auto_bwdtemp("IND", 2019)

auto_bwdtemp("ITA", 2019)
auto_bwdtemp("JPN", 2019)
auto_bwdtemp("KOR", 2019)
auto_bwdtemp("MEX", 2019)
auto_bwdtemp("NLD", 2019)

auto_bwdtemp("ROW", 2019)
auto_bwdtemp("SWE", 2019)
auto_bwdtemp("USA", 2019)
```

```{r}

#### Forward linkage sur base A17
auto_fwdtemp <- function(pays, annee_ref){

#On recupère les centres des kmeans sur l'annee de reference
LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays & year==annee_ref,][,link:="Bwd"]
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays & year==annee_ref,][,link:="Fwd"]
setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")

res.kmr <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)

#linkages fwd
LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country==pays,]

LinkageBwdFwd_A17_Fwd_tab<-dcast(LinkageBwdFwd_A17_Fwd,Col_Indus ~ year ,value.var="value") 
LinkageBwdFwd_A17_Fwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Fwd_tab))
colnames(LinkageBwdFwd_A17_Fwd_ttab)<-LinkageBwdFwd_A17_Fwd_ttab[1,]
LinkageBwdFwd_A17_Fwd_ttab<-LinkageBwdFwd_A17_Fwd_ttab[-1,]
LinkageBwdFwd_A17_Fwd_ttab<-setDF(LinkageBwdFwd_A17_Fwd_ttab)
LinkageBwdFwd_A17_Fwd_ttab<- mutate_all(LinkageBwdFwd_A17_Fwd_ttab, function(x) as.numeric(as.character(x)))

#clusters sur toutes les annees

clusters_pays_a <- clusters_p_a(pays, res.kmr)


#forme des points
shape=c(0:2,3,5,15,17:19)
#liste des indicateurs
List_BR<-colnames(LinkageBwdFwd_A17_Fwd_ttab)[2:18]

#plot de la premiere moitie des indicateurs de linkage
plot(LinkageBwdFwd_A17_Fwd_ttab[,1],LinkageBwdFwd_A17_Fwd_ttab[,2], xlab=c("Années", pays),ylab="Indic linkage 1/2",main="Forward Linkage du pays au format A17", type = "b", frame = FALSE, pch = shape[1], col = data.frame(t(cluster_pays_annee[1,]))$X1, ylim = c(-0.02,0.13))
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,3],pch = shape[2], col = data.frame(t(cluster_pays_annee[2,]))$X2 , type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,4],pch = shape[3], col = data.frame(t(cluster_pays_annee[3,]))$X3, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,5],pch = shape[4], col = data.frame(t(cluster_pays_annee[4,]))$X4, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,6],pch = shape[5], col = data.frame(t(cluster_pays_annee[5,]))$X5, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,7],pch = shape[6], col =data.frame(t(cluster_pays_annee[6,]))$X6, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,8],pch = shape[7], col = data.frame(t(cluster_pays_annee[7,]))$X7, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,9],pch = shape[8], col = data.frame(t(cluster_pays_annee[8,]))$X8, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,10],pch = shape[9], col =data.frame(t(cluster_pays_annee[9,]))$X9, type = "b", lty  =2)
legend(x = "bottomright", horiz = TRUE,legend = List_BR[1:9], pch = shape)
#plot de la deuxieme moitie des indicateurs de linkage
plot(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,11], xlab=c("Années", pays),ylab="Indic linkage 2/2",main="Forward Linkage du pays au format A17",pch = shape[1], col = data.frame(t(cluster_pays_annee[10,]))$X10, type = "b", frame = FALSE,  ylim = c(-0.02,0.13))
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,12],pch = shape[2], col = data.frame(t(cluster_pays_annee[11,]))$X11, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,13],pch = shape[3], col = data.frame(t(cluster_pays_annee[12,]))$X12, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,14],pch = shape[4], col = data.frame(t(cluster_pays_annee[13,]))$X13, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,15],pch = shape[5], col = data.frame(t(cluster_pays_annee[14,]))$X14, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,16],pch = shape[6], col =data.frame(t(cluster_pays_annee[15,]))$X15, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,17],pch = shape[7], col = data.frame(t(cluster_pays_annee[16,]))$X16, type = "b", lty  =2)
lines(LinkageBwdFwd_A17_Fwd_ttab[,1], LinkageBwdFwd_A17_Fwd_ttab[,18],pch = shape[8], col =data.frame(t(cluster_pays_annee[17,]))$X17, type = "b", lty  =2)
legend(x = "topright", horiz = TRUE, legend = List_BR[10:17], pch = shape[1:8])

}
```

```{r}
auto_fwdtemp("FRA",2019)
```

Tous les pays

```{r}
auto_fwdtemp("AUS", 2019)
auto_fwdtemp("AUT", 2019)
auto_fwdtemp("BEL", 2019)
auto_fwdtemp("BRA", 2019)
auto_fwdtemp("CAN", 2019)
auto_fwdtemp("CHN", 2019)
auto_fwdtemp("DEU", 2019)
auto_fwdtemp("DNK", 2019)
auto_fwdtemp("ESP", 2019)
auto_fwdtemp("FIN", 2019)
auto_fwdtemp("FRA", 2019)
auto_fwdtemp("GBR", 2019)
auto_fwdtemp("GRC", 2019)
auto_fwdtemp("IND", 2019)

auto_fwdtemp("ITA", 2019)
auto_fwdtemp("JPN", 2019)
auto_fwdtemp("KOR", 2019)
auto_fwdtemp("MEX", 2019)
auto_fwdtemp("NLD", 2019)

auto_fwdtemp("ROW", 2019)
auto_fwdtemp("SWE", 2019)
auto_fwdtemp("USA", 2019)
```






# Exploitation des bases : BASEres_LinkageBwdFwd_ECOLE ; BASEres_LinkageBwdFwd_A17 ; BASEres_LinkageBwdFwd_LRWIO 

#### Backward linkage sur base A17


# evolution_indicateurbwd_pays_A17 = function(pays){
#   setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")
#   LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country==pays,]
#   
#   LinkageBwdFwd_A17_Bwd_tab<-dcast(LinkageBwdFwd_A17_Bwd,Lig_Indus ~ year ,value.var="value") 
#   LinkageBwdFwd_A17_Bwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Bwd_tab))
#   colnames(LinkageBwdFwd_A17_Bwd_ttab)<-LinkageBwdFwd_A17_Bwd_ttab[1,]
#   LinkageBwdFwd_A17_Bwd_ttab<-LinkageBwdFwd_A17_Bwd_ttab[-1,]
#   LinkageBwdFwd_A17_Bwd_ttab<-setDF(LinkageBwdFwd_A17_Bwd_ttab)
#   LinkageBwdFwd_A17_Bwd_ttab<- mutate_all(LinkageBwdFwd_A17_Bwd_ttab, function(x) as.numeric(as.character(x)))
#   
#   
#   
#   List_BR<-colnames(LinkageBwdFwd_A17_Bwd_ttab)[2:18]
#   matplot(LinkageBwdFwd_A17_Bwd_ttab$Lig_Indus, LinkageBwdFwd_A17_Bwd_ttab[,2:18],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main=paste("Backward Linkage de ",paste(pays,"au format A17")))
#   legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))
#   dev.print(device = png,file = paste(pays,"_evolution_branche_Bwd.png"),width = 600)
# }
# for (pays in levels(factor(BDD_bwd$Lig_Country))){
#   evolution_indicateurbwd_pays_A17(pays)
# }
# 
# #### Forward linkage sur base A17
# 
# evolution_indicateurfwd_pays_A17 = function(pays){
#   setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")
#   LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Lig_Country==pays,]
#   
#   LinkageBwdFwd_A17_Fwd_tab<-dcast(LinkageBwdFwd_A17_Fwd,Lig_Indus ~ year ,value.var="value") 
#   LinkageBwdFwd_A17_Fwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Fwd_tab))
#   colnames(LinkageBwdFwd_A17_Fwd_ttab)<-LinkageBwdFwd_A17_Fwd_ttab[1,]
#   LinkageBwdFwd_A17_Fwd_ttab<-LinkageBwdFwd_A17_Fwd_ttab[-1,]
#   LinkageBwdFwd_A17_Fwd_ttab<-setDF(LinkageBwdFwd_A17_Fwd_ttab)
#   LinkageBwdFwd_A17_Fwd_ttab<- mutate_all(LinkageBwdFwd_A17_Fwd_ttab, function(x) as.numeric(as.character(x)))
#   
#   List_BR<-colnames(LinkageBwdFwd_A17_Fwd_ttab)[2:18]
#   matplot(LinkageBwdFwd_A17_Fwd_ttab$Lig_Indus, LinkageBwdFwd_A17_Fwd_ttab[,2:18],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main=paste("Forward Linkage de ",paste(pays,"au format A17")))
#   legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))
#   dev.print(device = png,file = paste(pays,"_evolution_branche_Fwd.png"),width = 600)
# }
# for (pays in levels(factor(BDD_bwd$Lig_Country))){
#   evolution_indicateurfwd_pays_A17(pays)
# }
# 
# # HEm
# evolution_indicateurHEM_WIOD = function(pays){
#   setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/by_country")
#   HEM_A17<-Baseres_HEM_A17_WIOD[Lig_Country==pays,]
#   HEM_A17_tab<-dcast(HEM_A17,Lig_Indus ~ year ,value.var="Indic_HEM") 
#   HEM_A17_ttab<-AddRownamesToFirstCol(t(HEM_A17_tab))
#   colnames(HEM_A17_ttab)<-HEM_A17_ttab[1,]
#   HEM_A17_ttab<-HEM_A17_ttab[-1,]
#   HEM_A17_ttab<-setDF(HEM_A17_ttab)
#   HEM_A17_ttab<- mutate_all(HEM_A17_ttab, function(x) as.numeric(as.character(x)))
#   
#   List_BR<-colnames(HEM_A17_ttab)[2:18]
#   matplot(HEM_A17_ttab$Lig_Indus, HEM_A17_ttab[,2:18],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic HEM",main=paste("HEM de ",paste(pays,"au format A17")))
#   legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))
#   dev.print(device = png,file = paste(pays,"_evolution_branche_HEM.png"),width = 600)
# }
# for (pays in levels(factor(Baseres_HEM_A17_WIOD$Lig_Country))){
#   evolution_indicateurHEM_WIOD(pays)
# }




# #### Backward linkage sur base ECOLE et sur toute la période
# 
# 
# LinkageBwdFwd_ECOLE_Bwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Bwd_byCountry"]][Lig_Country=="FRA",]
#   
# LinkageBwdFwd_ECOLE_Bwd_tab<-dcast(LinkageBwdFwd_ECOLE_Bwd,Lig_Indus ~ year ,value.var="value") 
# LinkageBwdFwd_ECOLE_Bwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_ECOLE_Bwd_tab))
# colnames(LinkageBwdFwd_ECOLE_Bwd_ttab)<-LinkageBwdFwd_ECOLE_Bwd_ttab[1,]
# LinkageBwdFwd_ECOLE_Bwd_ttab<-LinkageBwdFwd_ECOLE_Bwd_ttab[-1,]
# LinkageBwdFwd_ECOLE_Bwd_ttab<-setDF(LinkageBwdFwd_ECOLE_Bwd_ttab)
# LinkageBwdFwd_ECOLE_Bwd_ttab<- mutate_all(LinkageBwdFwd_ECOLE_Bwd_ttab, function(x) as.numeric(as.character(x)))
# 
# List_BR<-colnames(LinkageBwdFwd_ECOLE_Bwd_ttab)[2:5]
# matplot(LinkageBwdFwd_ECOLE_Bwd_ttab$Lig_Indus, LinkageBwdFwd_ECOLE_Bwd_ttab[,2:5],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main="Backward Linkage de la France au format ECOLE")
# legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))


```


############################################################################################################

PARTIE CLUSTER

############################################################################################################

```{r}
# Chargement des bases
BASE_ECOLE<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/BASE_ECOLE.rds")
BASE_A17<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/BASE_A17.rds")
Interm_LRWIOD<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/BDn_LR_WIOD.rds")
Interm_WIOD<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/BDn_WIOD.rds")
Interm_FIG<-readRDS("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/BDn_FIG.rds")

LRWIOD_FULL_1990_ALL<-CompoECOLEouA17(BASE_A17,"OptFullOptions",date=1990)
  
VRAI_WIOD_FULL_2007_FULL<-CompoMRIO(Interm_WIOD,"OptFullOptions",date=2007)

A_LRWIOD<-LRWIOD_FULL_1990_ALL[["A"]]

A_WIOD<-VRAI_WIOD_FULL_2007_FULL[["A"]]

A_LRWIOD_DOM<-A_LRWIOD[Lig_Country==Col_Country,]
A_LRWIOD_IMPEXP<-A_LRWIOD[Lig_Country!=Col_Country,]

A_WIOD_DOM<-A_WIOD[Lig_Country==Col_Country,]
A_WIOD_IMPEXP<-A_WIOD[Lig_Country!=Col_Country,]

# Cas particulier
AAA<-AjoutPRBR(A_LRWIOD_IMPEXP)
AAA_tab<-dcast(AAA, PR ~ BR, value.var = "value") # Mise en format tab 
AAA_tab<-GereInfNA(AAA_tab)


plot(density(AAA$value))
boxplot(AAA$value)
print(mean(AAA$value))
print(median(AAA$value))

AAA_SelectSeuil<-AAA[value<mean(AAA$value),value:=0]
AAA_SelectSeuil_tab<-dcast(AAA_SelectSeuil, PR ~ BR, value.var = "value") # Mise en format tab 
AAA_SelectSeuil_tab<-GereInfNA(AAA_SelectSeuil_tab)

# Partie triangulation par Dulmage-Mendhelson
library(Matrix)
interm<-setDF(AAA_SelectSeuil_tab)
Matdf<-GetRownamesFromFirstCol(interm)
Mat<-as.matrix(Matdf,sparse=TRUE)

MatSparse<-as(Mat, "dgTMatrix") 
class(MatSparse)

# https://search.r-project.org/CRAN/refmans/Matrix/html/dgCMatrix-class.html
# https://search.r-project.org/CRAN/refmans/Matrix/html/dmperm.html
#detach("package:Matrix", unload=TRUE)  # Pour réinstaller le package Matrix dernière version (manuellement) si besoin
Mat_dm<-Matrix::dmperm(MatSparse, nAns = 6L, seed = 0L)


```

Changes in version 1.4-1 (2022-03-21 r3446)
Bug Fixes

    diag(x) methods now mostly also keep names from dimnames(x) by default and obey names=* more generally.

New Features

    New virtual class packedMatrix containing packed (dense) symmetric and triangular matrices. Methods for subscripting, including diag(), notably keeping names by default and for t() which are memory efficient, i.e., do not work via unpacking, thanks to Mikael Jagan.

    New dmperm() implementing a Dulmage-Mendelsohn decomposition, thanks to the persistency of Mauricio Vargas (@uc.cl).

    Export more low-level conversion utilities: .n2dgT, .m2ngCn, .m2ngTn.

    Provide some matrix multiplication methods for "RsparseMatrix".


**Lecture des sorties de la décomposition des Dulmage-Mendhelson**

dmperm {Matrix} : For any n×mn (typically) sparse matrix x compute the Dulmage-Mendelsohn row and columns permutations which at first splits the nnn rows and m columns into coarse partitions each; and then a finer one, reordering rows and columns such that the permutated matrix is “as upper triangular” as possible. 

dmperm(x, nAns = 6L, seed = 0L)

Arguments
x 	 : a typically sparse matrix; internally coerced to either "dgCMatrix" or "dtCMatrix".
nAns 	: an integer specifying the length of the resulting list. Must be 2, 4, or 6.
seed 	: an integer code in -1,0,1; determining the (initial) permutation; by default, seed = 0, no (or the identity) permutation; seed = -1 uses the “reverse” permutation k:1; for seed = 1, it is a random permutation (using R's RNG, seed, etc).

Sorties : a named list with (by default) 6 components,
p 	: integer vector with the permutation p, of length nrow(x).
q 	: integer vector with the permutation q, of length ncol(x).
r 	: integer vector of length nb+1, where block k is rows r[k] to r[k+1]-1 in A[p,q].
s 	: integer vector of length nb+1, where block k is cols s[k] to s[k+1]-1 in A[p,q].
rr5 	: integer vector of length 5, defining the coarse row decomposition.
cc5 	: integer vector of length 5, defining the coarse column decomposition.

Tutoriel 1 : simple trouvé en ligne
```{r}
set.seed(17)
(S9 <- rsparsematrix(9, 9, nnz = 10, symmetric=TRUE)) # dsCMatrix
str( dm9 <- dmperm(S9) )
(S9p <- with(dm9, S9[p, q]))
## looks good, but *not* quite upper triangular; these, too:
str( dm9.0 <- dmperm(S9, seed=-1)) # non-random too.
str( dm9_1 <- dmperm(S9, seed= 1)) # a random one
## The last two permutations differ, but have the same effect!
(S9p0 <- with(dm9.0, S9[p, q])) # .. hmm ..
stopifnot(all.equal(S9p0, S9p))# same as as default, but different from the random one
```
> set.seed(17)
> (S9 <- rsparsematrix(9, 9, nnz = 10, symmetric=TRUE)) # dsCMatrix
9 x 9 sparse Matrix of class "dsCMatrix"
                                                  
 [1,] -0.055 .    .    .    .   .    1.6 .    .   
 [2,]  .     .    .    .    .   0.84 .   0.64 .   
 [3,]  .     .    0.63 .    .   .    .   .    1.30
 [4,]  .     .    .    0.16 .   .    .   .    0.37
 [5,]  .     .    .    .    .   .    .   1.20 .   
 [6,]  .     0.84 .    .    .   .    .   .    0.19
 [7,]  1.600 .    .    .    .   .    .   .    .   
 [8,]  .     0.64 .    .    1.2 .    .   .    .   
 [9,]  .     .    1.30 0.37 .   0.19 .   .    .   
> str( dm9 <- dmperm(S9) )
List of 6
 $ p  : int [1:9] 1 7 8 6 9 4 3 2 5
 $ q  : int [1:9] 7 1 5 2 3 4 9 6 8
 $ r  : int [1:8] 0 1 2 3 4 7 8 9
 $ s  : int [1:8] 0 1 2 3 4 7 8 9
 $ rr5: int [1:5] 0 0 9 9 9
 $ cc5: int [1:5] 0 0 0 9 9
> (S9p <- with(dm9, S9[p, q]))
9 x 9 sparse Matrix of class "dgCMatrix"
                                                  
 [1,] 1.6 -0.055 .   .    .    .    .    .    .   
 [2,] .    1.600 .   .    .    .    .    .    .   
 [3,] .    .     1.2 0.64 .    .    .    .    .   
 [4,] .    .     .   0.84 .    .    0.19 .    .   
 [5,] .    .     .   .    1.30 0.37 .    0.19 .   
 [6,] .    .     .   .    .    0.16 0.37 .    .   
 [7,] .    .     .   .    0.63 .    1.30 .    .   
 [8,] .    .     .   .    .    .    .    0.84 0.64
 [9,] .    .     .   .    .    .    .    .    1.20
> ## looks good, but *not* quite upper triangular; these, too:
> str( dm9.0 <- dmperm(S9, seed=-1)) # non-random too.
List of 6
 $ p  : int [1:9] 1 7 8 6 9 4 3 2 5
 $ q  : int [1:9] 7 1 5 2 3 4 9 6 8
 $ r  : int [1:8] 0 1 2 3 4 7 8 9
 $ s  : int [1:8] 0 1 2 3 4 7 8 9
 $ rr5: int [1:5] 0 0 9 9 9
 $ cc5: int [1:5] 0 0 0 9 9
> str( dm9_1 <- dmperm(S9, seed= 1)) # a random one
List of 6
 $ p  : int [1:9] 1 7 8 6 3 9 4 2 5
 $ q  : int [1:9] 7 1 5 2 3 4 9 6 8
 $ r  : int [1:8] 0 1 2 3 4 7 8 9
 $ s  : int [1:8] 0 1 2 3 4 7 8 9
 $ rr5: int [1:5] 0 0 9 9 9
 $ cc5: int [1:5] 0 0 0 9 9
> ## The last two permutations differ, but have the same effect!
> (S9p0 <- with(dm9.0, S9[p, q])) # .. hmm ..
9 x 9 sparse Matrix of class "dgCMatrix"
                                                  
 [1,] 1.6 -0.055 .   .    .    .    .    .    .   
 [2,] .    1.600 .   .    .    .    .    .    .   
 [3,] .    .     1.2 0.64 .    .    .    .    .   
 [4,] .    .     .   0.84 .    .    0.19 .    .   
 [5,] .    .     .   .    1.30 0.37 .    0.19 .   
 [6,] .    .     .   .    .    0.16 0.37 .    .   
 [7,] .    .     .   .    0.63 .    1.30 .    .   
 [8,] .    .     .   .    .    .    .    0.84 0.64
 [9,] .    .     .   .    .    .    .    .    1.20
> stopifnot(all.equal(S9p0, S9p))# same as as default, but different from the random one

Tuto 2 :
```{r}

set.seed(11)
(M <- triu(rsparsematrix(9,11, 1/4)))
dM <- dmperm(M); with(dM, M[p, q])
(Mp <- M[sample.int(nrow(M)), sample.int(ncol(M))])
dMp <- dmperm(Mp); with(dMp, Mp[p, q])

```

Tuto 3 :
```{r}
set.seed(7)
(n7 <- rsparsematrix(5, 12, nnz = 10, rand.x = NULL))
str( dm.7 <- dmperm(n7) )
stopifnot(exprs = {
  lengths(dm.7[1:2]) == dim(n7)
  identical(dm.7,      dmperm(as(n7, "dMatrix")))
  identical(dm.7[1:4], dmperm(n7, nAns=4))
  identical(dm.7[1:2], dmperm(n7, nAns=2))
})
```
{}

```{r essai Loic}


```



```{r Linkage ACP}

#Rem: Faire une ACP avec en individus les branches et en variables les indicateurs Forward et Backward n'est pas malin du tout ! L'idée est de faire une ACP pour une année donnée avec en individus les pays et en variables les branches !

######## 2019 ########

  #setwd("C:/Users/Bendounan Adel/Documents/Projet_methodo_3A/stat_desc_projetmethodo/image_analyse_multi/acp")
  test<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2019",]
  test_PCA <- pivot_wider(data = test, names_from = Lig_Indus, values_from = value)
  test_PCA <- select(test_PCA, - "year")
  data_2019 <- test_PCA %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

  PCAshiny(data_2019)


######## 2014 #########

test<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2014",]
test_PCA <- pivot_wider(data = test, names_from = Lig_Indus, values_from = value)
test_PCA <- select(test_PCA, - "year")
data_2014 <- test_PCA %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_2014)

########### 2009 ###########

test<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2009",]
test_PCA <- pivot_wider(data = test, names_from = Lig_Indus, values_from = value)
test_PCA <- select(test_PCA, - "year")
data_2009 <- test_PCA %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_2009)

########### 2004 ############

test<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2004",]
test_PCA <- pivot_wider(data = test, names_from = Lig_Indus, values_from = value)
test_PCA <- select(test_PCA, - "year")
data_2004 <- test_PCA %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_2004)


######## ACP avec Forward et Backward #######

# LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA" & year=="2019",][,link:="Bwd"]
# LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Col_Country=="FRA" & year=="2019",][,link:="Fwd"]
# setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)

###### Code Adel propre #####

###### ACP sur l'année 2019 ########
test_bwd = BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2014",][,link:="Bwd"]
test_fwd = BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][year=="2014",][,link:="Fwd"]
test_bwd_dom = BASEres_LinkageBwdFwd_A17[["Indic_Bwd_PartDOM"]][year=="2004",][,link:="Bwd"]
test_fwd_dom = BASEres_LinkageBwdFwd_A17[["Indic_Fwd_PartDOM"]][year=="2004",][,link:="Fwd"]
setnames(test_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
test_fwd_dom = merge(test_fwd,test_fwd_dom,by = c("Lig_Country","Lig_Indus","year","link"))
test_fwd_dom = test_fwd_dom %>%
  mutate(value_Dom = value*Part_Dom,branche_link = paste(Lig_Indus,link,sep = "_"))
setnames(test_bwd_dom,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
test_bwd_dom = merge(test_bwd,test_bwd_dom,by = c("Lig_Country","Lig_Indus","year","link"))
test_bwd_dom = test_bwd_dom %>%
  mutate(value_Dom = value*Part_Dom,branche_link = paste(Lig_Indus,link,sep = "_"))

test_bwd_dom <- select(test_bwd_dom, c(-"year",-"Lig_Indus",-"link"))
test_bwd_dom = dcast(test_bwd_dom,Lig_Country ~ branche_link ,value.var="value_Dom") 
test_bwd_dom <- test_bwd_dom %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(test_bwd_dom)

test_fwd_dom <- select(test_fwd_dom, c(-"year",-"Lig_Indus",-"link"))
test_fwd_dom = dcast(test_fwd_dom,Lig_Country ~ branche_link ,value.var="value_Dom") 
test_fwd_dom <- test_fwd_dom %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(test_fwd_dom)

setnames(test_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17_2019<-rbind(test_bwd,test_fwd)
LinkageBwdFwd_A17_2019 = LinkageBwdFwd_A17_2019 %>%
  mutate(branche_link = paste(Lig_Indus,link,sep = "_"))

test_bwd_fwd_PCA_2019 <- select(LinkageBwdFwd_A17_2019, c(-"year",-"Lig_Indus",-"link"))
test_bwd_fwd_PCA_2019 = dcast(test_bwd_fwd_PCA_2019,Lig_Country ~ branche_link ,value.var="value") 
data_bwd_fwd_2019 <- test_bwd_fwd_PCA_2019 %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_bwd_fwd_2019)

test_HEM = Baseres_HEM_A17_WIOD[Baseres_HEM_A17_WIOD$year=="2004",]
#setnames(test_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
test_HEM_PCA = dcast(test_HEM,Lig_Country ~ Lig_Indus ,value.var="Indic_HEM") 
test_HEM_PCA <- test_HEM_PCA %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(test_HEM_PCA)

####### ACP sur l'année 2014 #########

test_bwd = BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2014",][,link:="Bwd"]
test_fwd = BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][year=="2014",][,link:="Fwd"]
setnames(test_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17_2014<-rbind(test_bwd,test_fwd)
LinkageBwdFwd_A17_2014 = LinkageBwdFwd_A17_2014 %>%
  mutate(branche_link = paste(Lig_Indus,link,sep = "_"))

test_bwd_fwd_PCA_2014 <- select(LinkageBwdFwd_A17_2014, c(-"year",-"Lig_Indus",-"link"))

test_bwd_fwd_PCA_2014 = dcast(test_bwd_fwd_PCA_2014,Lig_Country ~ branche_link ,value.var="value") 
data_bwd_fwd_2014 <- test_bwd_fwd_PCA_2014 %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_bwd_fwd_2014)


####### ACP sur l'année 2009 #########

test_bwd = BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2009",][,link:="Bwd"]
test_fwd = BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][year=="2009",][,link:="Fwd"]
setnames(test_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17_2009<-rbind(test_bwd,test_fwd)
LinkageBwdFwd_A17_2009 = LinkageBwdFwd_A17_2009 %>%
  mutate(branche_link = paste(Lig_Indus,link,sep = "_"))

test_bwd_fwd_PCA_2009 <- select(LinkageBwdFwd_A17_2009, c(-"year",-"Lig_Indus",-"link"))

test_bwd_fwd_PCA_2009 = dcast(test_bwd_fwd_PCA_2009,Lig_Country ~ branche_link ,value.var="value") 
data_bwd_fwd_2009 <- test_bwd_fwd_PCA_2009 %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_bwd_fwd_2009)

####### ACP sur l'année 2004 #########

test_bwd = BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year=="2004",][,link:="Bwd"]
test_fwd = BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][year=="2004",][,link:="Fwd"]
setnames(test_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
LinkageBwdFwd_A17_2004<-rbind(test_bwd,test_fwd)
LinkageBwdFwd_A17_2004 = LinkageBwdFwd_A17_2004 %>%
  mutate(branche_link = paste(Lig_Indus,link,sep = "_"))

test_bwd_fwd_PCA_2004 <- select(LinkageBwdFwd_A17_2004, c(-"year",-"Lig_Indus",-"link"))

test_bwd_fwd_PCA_2004 = dcast(test_bwd_fwd_PCA_2004,Lig_Country ~ branche_link ,value.var="value") 
data_bwd_fwd_2004 <- test_bwd_fwd_PCA_2004 %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

PCAshiny(data_bwd_fwd_2004)

################# AFM (gp formé par année) #################

# newDF <- data_AFM[,c("AZ_Bwd_2010","C1_Bwd_2010","C2_Bwd_2010","C3_Bwd_2010","C4_Bwd_2010","C5_Bwd_2010","DE_Bwd_2010","FZ_Bwd_2010","GZ_Bwd_2010","HZ_Bwd_2010","IZ_Bwd_2010","JZ_Bwd_2010","KZ_Bwd_2010","LZ_Bwd_2010","MN_Bwd_2010","OQ_Bwd_2010","RU_Bwd_2010","AZ_Fwd_2010","C1_Fwd_2010","C2_Fwd_2010","C3_Fwd_2010","C4_Fwd_2010","C5_Fwd_2010","DE_Fwd_2010","FZ_Fwd_2010","GZ_Fwd_2010","HZ_Fwd_2010","IZ_Fwd_2010","JZ_Fwd_2010","KZ_Fwd_2010","LZ_Fwd_2010","MN_Fwd_2010","OQ_Fwd_2010","RU_Fwd_2010","AZ_Bwd_2011","C1_Bwd_2011","C2_Bwd_2011","C3_Bwd_2011","C4_Bwd_2011","C5_Bwd_2011","DE_Bwd_2011","FZ_Bwd_2011","GZ_Bwd_2011","HZ_Bwd_2011","IZ_Bwd_2011","JZ_Bwd_2011","KZ_Bwd_2011","LZ_Bwd_2011","MN_Bwd_2011","OQ_Bwd_2011","RU_Bwd_2011","AZ_Fwd_2011","C1_Fwd_2011","C2_Fwd_2011","C3_Fwd_2011","C4_Fwd_2011","C5_Fwd_2011","DE_Fwd_2011","FZ_Fwd_2011","GZ_Fwd_2011","HZ_Fwd_2011","IZ_Fwd_2011","JZ_Fwd_2011","KZ_Fwd_2011","LZ_Fwd_2011","MN_Fwd_2011","OQ_Fwd_2011","RU_Fwd_2011","AZ_Bwd_2012","C1_Bwd_2012","C2_Bwd_2012","C3_Bwd_2012","C4_Bwd_2012","C5_Bwd_2012","DE_Bwd_2012","FZ_Bwd_2012","GZ_Bwd_2012","HZ_Bwd_2012","IZ_Bwd_2012","JZ_Bwd_2012","KZ_Bwd_2012","LZ_Bwd_2012","MN_Bwd_2012","OQ_Bwd_2012","RU_Bwd_2012","AZ_Fwd_2012","C1_Fwd_2012","C2_Fwd_2012","C3_Fwd_2012","C4_Fwd_2012","C5_Fwd_2012","DE_Fwd_2012","FZ_Fwd_2012","GZ_Fwd_2012","HZ_Fwd_2012","IZ_Fwd_2012","JZ_Fwd_2012","KZ_Fwd_2012","LZ_Fwd_2012","MN_Fwd_2012","OQ_Fwd_2012","RU_Fwd_2012","AZ_Bwd_2013","C1_Bwd_2013","C2_Bwd_2013","C3_Bwd_2013","C4_Bwd_2013","C5_Bwd_2013","DE_Bwd_2013","FZ_Bwd_2013","GZ_Bwd_2013","HZ_Bwd_2013","IZ_Bwd_2013","JZ_Bwd_2013","KZ_Bwd_2013","LZ_Bwd_2013","MN_Bwd_2013","OQ_Bwd_2013","RU_Bwd_2013","AZ_Fwd_2013","C1_Fwd_2013","C2_Fwd_2013","C3_Fwd_2013","C4_Fwd_2013","C5_Fwd_2013","DE_Fwd_2013","FZ_Fwd_2013","GZ_Fwd_2013","HZ_Fwd_2013","IZ_Fwd_2013","JZ_Fwd_2013","KZ_Fwd_2013","LZ_Fwd_2013","MN_Fwd_2013","OQ_Fwd_2013","RU_Fwd_2013","AZ_Bwd_2014","C1_Bwd_2014","C2_Bwd_2014","C3_Bwd_2014","C4_Bwd_2014","C5_Bwd_2014","DE_Bwd_2014","FZ_Bwd_2014","GZ_Bwd_2014","HZ_Bwd_2014","IZ_Bwd_2014","JZ_Bwd_2014","KZ_Bwd_2014","LZ_Bwd_2014","MN_Bwd_2014","OQ_Bwd_2014","RU_Bwd_2014","AZ_Fwd_2014","C1_Fwd_2014","C2_Fwd_2014","C3_Fwd_2014","C4_Fwd_2014","C5_Fwd_2014","DE_Fwd_2014","FZ_Fwd_2014","GZ_Fwd_2014","HZ_Fwd_2014","IZ_Fwd_2014","JZ_Fwd_2014","KZ_Fwd_2014","LZ_Fwd_2014","MN_Fwd_2014","OQ_Fwd_2014","RU_Fwd_2014","AZ_Bwd_2015","C1_Bwd_2015","C2_Bwd_2015","C3_Bwd_2015","C4_Bwd_2015","C5_Bwd_2015","DE_Bwd_2015","FZ_Bwd_2015","GZ_Bwd_2015","HZ_Bwd_2015","IZ_Bwd_2015","JZ_Bwd_2015","KZ_Bwd_2015","LZ_Bwd_2015","MN_Bwd_2015","OQ_Bwd_2015","RU_Bwd_2015","AZ_Fwd_2015","C1_Fwd_2015","C2_Fwd_2015","C3_Fwd_2015","C4_Fwd_2015","C5_Fwd_2015","DE_Fwd_2015","FZ_Fwd_2015","GZ_Fwd_2015","HZ_Fwd_2015","IZ_Fwd_2015","JZ_Fwd_2015","KZ_Fwd_2015","LZ_Fwd_2015","MN_Fwd_2015","OQ_Fwd_2015","RU_Fwd_2015","AZ_Bwd_2016","C1_Bwd_2016","C2_Bwd_2016","C3_Bwd_2016","C4_Bwd_2016","C5_Bwd_2016","DE_Bwd_2016","FZ_Bwd_2016","GZ_Bwd_2016","HZ_Bwd_2016","IZ_Bwd_2016","JZ_Bwd_2016","KZ_Bwd_2016","LZ_Bwd_2016","MN_Bwd_2016","OQ_Bwd_2016","RU_Bwd_2016","AZ_Fwd_2016","C1_Fwd_2016","C2_Fwd_2016","C3_Fwd_2016","C4_Fwd_2016","C5_Fwd_2016","DE_Fwd_2016","FZ_Fwd_2016","GZ_Fwd_2016","HZ_Fwd_2016","IZ_Fwd_2016","JZ_Fwd_2016","KZ_Fwd_2016","LZ_Fwd_2016","MN_Fwd_2016","OQ_Fwd_2016","RU_Fwd_2016","AZ_Bwd_2017","C1_Bwd_2017","C2_Bwd_2017","C3_Bwd_2017","C4_Bwd_2017","C5_Bwd_2017","DE_Bwd_2017","FZ_Bwd_2017","GZ_Bwd_2017","HZ_Bwd_2017","IZ_Bwd_2017","JZ_Bwd_2017","KZ_Bwd_2017","LZ_Bwd_2017","MN_Bwd_2017","OQ_Bwd_2017","RU_Bwd_2017","AZ_Fwd_2017","C1_Fwd_2017","C2_Fwd_2017","C3_Fwd_2017","C4_Fwd_2017","C5_Fwd_2017","DE_Fwd_2017","FZ_Fwd_2017","GZ_Fwd_2017","HZ_Fwd_2017","IZ_Fwd_2017","JZ_Fwd_2017","KZ_Fwd_2017","LZ_Fwd_2017","MN_Fwd_2017","OQ_Fwd_2017","RU_Fwd_2017","AZ_Bwd_2018","C1_Bwd_2018","C2_Bwd_2018","C3_Bwd_2018","C4_Bwd_2018","C5_Bwd_2018","DE_Bwd_2018","FZ_Bwd_2018","GZ_Bwd_2018","HZ_Bwd_2018","IZ_Bwd_2018","JZ_Bwd_2018","KZ_Bwd_2018","LZ_Bwd_2018","MN_Bwd_2018","OQ_Bwd_2018","RU_Bwd_2018","AZ_Fwd_2018","C1_Fwd_2018","C2_Fwd_2018","C3_Fwd_2018","C4_Fwd_2018","C5_Fwd_2018","DE_Fwd_2018","FZ_Fwd_2018","GZ_Fwd_2018","HZ_Fwd_2018","IZ_Fwd_2018","JZ_Fwd_2018","KZ_Fwd_2018","LZ_Fwd_2018","MN_Fwd_2018","OQ_Fwd_2018","RU_Fwd_2018","AZ_Bwd_2019","C1_Bwd_2019","C2_Bwd_2019","C3_Bwd_2019","C4_Bwd_2019","C5_Bwd_2019","DE_Bwd_2019","FZ_Bwd_2019","GZ_Bwd_2019","HZ_Bwd_2019","IZ_Bwd_2019","JZ_Bwd_2019","KZ_Bwd_2019","LZ_Bwd_2019","MN_Bwd_2019","OQ_Bwd_2019","RU_Bwd_2019","AZ_Fwd_2019","C1_Fwd_2019","C2_Fwd_2019","C3_Fwd_2019","C4_Fwd_2019","C5_Fwd_2019","DE_Fwd_2019","FZ_Fwd_2019","GZ_Fwd_2019","HZ_Fwd_2019","IZ_Fwd_2019","JZ_Fwd_2019","KZ_Fwd_2019","LZ_Fwd_2019","MN_Fwd_2019","OQ_Fwd_2019","RU_Fwd_2019")]
# res.MFA<-MFA(newDF,group=c(34,34,34,34,34,34,34,34,34,34), type=c("s","s","s","s","s","s","s","s","s","s"),ind.sup=c(19),name.group=c("2010","2011","2012","2013","2014","2015","2016","2017","2018","2019"),graph=FALSE)
# plot.MFA(res.MFA, choix="ind",partial='all',lab.par=FALSE,habillage='group',title="Graphe des individus AFM 2010-2019",cex=0.85,cex.main=0.85,cex.axis=0.85)
# plot.MFA(res.MFA, choix="var",select='cos2 0',habillage='group',title="Cercle des corrélations AFM 2010-2019")
# plot.MFA(res.MFA, choix="group",title="Graphe des groupes AFM 2010-2019")
# plot.MFA(res.MFA, choix="axes",title="Graphe des axes partiels AFM 2010-2019",habillage='group')
link = "bwd"
test_afm_bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][,link:="Bwd"]
link = "fwd"
test_afm_fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][,link:="Fwd"]
setnames(test_afm_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
test_afm<-rbind(test_afm_bwd,test_afm_fwd)

# statistiques_desc = test_afm %>%
#   group_by(Lig_Country,year,link) %>%
#   summarise(missing_va = sum(is.na(value)),avg = mean(value),ecart_t = sd(value),med = median(value),min = min(value),q1 = quantile(value,probs = 0.25),q3 = quantile(value,probs = 0.75),max = max(value),label_min = Lig_Indus[min],label_max = Lig_Indus[max])
# 
# statistiques_desc_essa = test_afm %>%
#   group_by(Lig_Country,year,link) %>%
#   filter(value == min(value))#Ajouter les libelles serait une bonne idée !

#missing_va = sum(is.na(value))
#libel_min = paste(Lig_Indus[min(value)],c(Lig_Indus[quantile(value,probs = 0.07)],Lig_Indus[quantile(value,probs = 0.13)]))
test_AFM <- pivot_wider(data = test_afm_bwd, names_from = c(Lig_Indus,link,year), values_from = value)
data_AFM <- test_AFM %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

annee = 2000:2020
annee = as.character(annee)
library(factoextra)


res.MFA<-MFA(data_AFM,group=rep(17,21), type=rep("s",21),ind.sup = c(6,14,19),name.group=annee,graph=FALSE)
summary(res.MFA)


#### Interactive graph
# liste = plotMFApartial(res.MFA)
# plot(res,choix="ind",habillage = "Terroir")
fviz_screeplot(res.MFA)
# fviz_mfa_var(res.MFA, "group")
# fviz_mfa_var(res.MFA, "quanti.var", palette = "rainbow", 
#              col.var.sup = "violet", repel = TRUE,
#              geom = c("point", "text"), legend = "bottom")
fviz_contrib (res.MFA, choice = "quanti.var", axes = 1, top = 20,
             palette = "rainbow",title = paste("20 plus hautes contributions à la dim 1 de l'AFM sur les",link))
fviz_cos2(res.MFA, choice = "quanti.var", axes = 1, top = 20,
             palette = "rainbow",title = paste("20 plus hauts cos2 à la dim 1 de l'AFM sur les",link))
fviz_contrib (res.MFA, choice = "quanti.var", axes = 2, top = 20,
             palette = "rainbow",title = paste("20 plus hautes contributions à la dim 2 de l'AFM sur les",link))
fviz_cos2(res.MFA, choice = "quanti.var", axes = 2, top = 20,
             palette = "rainbow",title = paste("20 plus hauts cos2 à la dim 2 de l'AFM sur les",link))
fviz_contrib (res.MFA, choice = "quanti.var", axes = 3, top = 20,
             palette = "rainbow",title = paste("20 plus hautes contributions à la dim 3 de l'AFM sur les",link))
fviz_cos2(res.MFA, choice = "quanti.var", axes = 3, top = 20,
             palette = "rainbow",title = paste("20 plus hauts cos2 à la dim 3 de l'AFM sur les",link))

fviz_contrib (res.MFA, "group", axes = 3,title = paste("Contributions par groupe à la dim 3 de l'AFM sur les",link))
fviz_contrib (res.MFA, "group", axes = 2,title = paste("Contributions par groupe à la dim 2 de l'AFM sur les",link))
fviz_cos2 (res.MFA, "group", axes = 3,title = paste("Cos2 par groupe à la dim 3 de l'AFM sur les",link))
fviz_cos2 (res.MFA, "group", axes = 2,title = paste("Cos2 par groupe à la dim 2 de l'AFM sur les",link))
fviz_contrib (res.MFA, "group", axes = 1,title = paste("Contributions par groupe à la dim 1 de l'AFM sur les",link))
fviz_cos2 (res.MFA, "group", axes = 1,title = paste("Cos2 par groupe à la dim 1 de l'AFM sur les",link))
# fviz_mfa_axes (res.MFA)
paste("Graphe des individus AFM 2000-2020",link)

plot.MFA(res.MFA, choix="ind",lab.par=FALSE,habillage="group",title=paste("Graphe des individus AFM 2000-2020",link),cex=0.85,cex.main=0.85,partial = "all",cex.axis=0.85)
plot.MFA(res.MFA, choix="var",select='cos2 0',habillage='group',title= paste("Cercle des corrélations AFM 2000-2020",link))
plot.MFA(res.MFA, choix="group",title=paste("Graphe des groupes AFM 2000-2020",link),cex=0.25,cex.main=0.8,cex.axis=0.8)
plot.MFA(res.MFA, choix="axes",title=paste("Graphe des axes partiels AFM 2000-2020",link),habillage='group',max.overlaps = 200)
S

# sd_byvar = skim(data_AFM)
# data_AFM_t = t(data_AFM)
# sd_bycountry = skim(data_AFM_t)

MFAshiny(data_AFM)

################# AFM (gp formé par variable) #################

test_afm_bwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Bwd_byCountry"]][year=="2010" | year=="2011" | year=="2012" | year=="2013" | year=="2014" ,][,link:="Bwd"]
test_afm_fwd<-BASEres_LinkageBwdFwd_ECOLE[["Indic_Fwd_byCountry"]][year=="2010" | year=="2011" | year=="2012" | year=="2013" | year=="2014" ,][,link:="Fwd"]
#setnames(test_afm_fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
test_afm<-rbind(test_afm_bwd,test_afm_fwd)

test_AFM <- pivot_wider(data = test_afm, names_from = c(Lig_Indus,link,year), values_from = value)
data_AFM <- test_AFM %>%
     remove_rownames() %>%
     column_to_rownames(var = 'Lig_Country')

MFAshiny(data_AFM)

#annee = "2018"
# acp_bwd_annee = function(annee){
#   test<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][year==annee,]
#   test_PCA <- pivot_wider(data = test, names_from = Lig_Indus, values_from = value)
#   test_PCA <- select(test_PCA, - "year")
#   data_2019 <- test_PCA %>%
#      remove_rownames() %>%
#      column_to_rownames(var = 'Lig_Country')
#   PCAshiny(data_2019)
# }
# acp_bwd_annee("2018")

```
```{r}
#### Backward linkage sur base A17
# km_annee = function(annee){
#   LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA" & year==annee,][,link:="Bwd"]
# LinkageBwdFwd_A17_Fwd<-BASEres_LinkageBwdFwd_A17[["Indic_Fwd_byCountry"]][Lig_Country=="FRA" & year==annee,][,link:="Fwd"]
# #setnames(LinkageBwdFwd_A17_Fwd,c("Col_Country","Col_Indus"),c("Lig_Country","Lig_Indus"))
# LinkageBwdFwd_A17<-rbind(LinkageBwdFwd_A17_Bwd,LinkageBwdFwd_A17_Fwd)
# 
# LinkageBwdFwd_A17_tab<-dcast(LinkageBwdFwd_A17,Lig_Indus ~ link,value.var="value")
# 
# res.km <- kmeans(scale(LinkageBwdFwd_A17_tab[,c(2:3)]), 4, nstart = 10)
# LinkageBwdFwd_A17_tab$cluster <- res.km$cluster
# data_clustering = LinkageBwdFwd_A17_tab[,c(-2,-3)]
# colnames(data_clustering) = c("Lig_Indus",as.character(annee))
# return(data_clustering)
# }
# data_cluster = km_annee(2000)
# for (k in 2001:2019){
#   data_cluster = merge(data_cluster,km_annee(k),by = "Lig_Indus")
# }
# data_cluster = t(data_cluster)
# colnames(data_cluster) = data_cluster[1,]
# data_cluster = data_cluster[-1,]
# data_cluster = apply(data_cluster,c(1,2),as.numeric)
# Lig_Indus = rownames(data_cluster)
# data_cluster = cbind(Lig_Indus,data_cluster)
# 
# List_BR<-colnames(data_cluster)[2:18]
# matplot(data_cluster[,1], data_cluster[,2:18],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main=paste("Backward Linkage de ",paste(pays,"au format A17")))
# legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))
# # dev.print(device = png,file = paste(pays,"_evolution_branche_Bwd.png"),width = 600)
# 
# LinkageBwdFwd_A17_Bwd<-BASEres_LinkageBwdFwd_A17[["Indic_Bwd_byCountry"]][Lig_Country=="FRA",]
#   
# LinkageBwdFwd_A17_Bwd_tab<-dcast(LinkageBwdFwd_A17_Bwd,Lig_Indus ~ year ,value.var="value") 
# LinkageBwdFwd_A17_Bwd_ttab<-AddRownamesToFirstCol(t(LinkageBwdFwd_A17_Bwd_tab))
# colnames(LinkageBwdFwd_A17_Bwd_ttab)<-LinkageBwdFwd_A17_Bwd_ttab[1,]
# LinkageBwdFwd_A17_Bwd_ttab<-LinkageBwdFwd_A17_Bwd_ttab[-1,]
# LinkageBwdFwd_A17_Bwd_ttab<-setDF(LinkageBwdFwd_A17_Bwd_ttab)
# LinkageBwdFwd_A17_Bwd_ttab<- mutate_all(LinkageBwdFwd_A17_Bwd_ttab, function(x) as.numeric(as.character(x)))
# 
# 
# List_BR<-colnames(LinkageBwdFwd_A17_Bwd_ttab)[2:18]
# matplot(LinkageBwdFwd_A17_Bwd_ttab$Lig_Indus, LinkageBwdFwd_A17_Bwd_ttab[,2:18],type="b",col= hcl.colors(10, "Temps"),pch=c(16,1),xlab="années",ylab="Indic linkage",main=paste("Backward Linkage de ",paste(pays,"au format A17")))
# legend(x="bottomleft", legend=List_BR, fill =hcl.colors(10, "Temps"))
# dev.print(device = png,file = paste(pays,"_evolution_branche_Bwd.png"),width = 600)
```



Sortie XLS
```{r}
write.xlsx(MadeInIrlande_A17_tab, "Made-in Irland.xlsx", sheetName = "Made-in", col.names = TRUE, row.names = TRUE)
write.xlsx(MadeInIrlande_A17_ttab, "Made-in Irland.xlsx", sheetName = "Transposee", col.names = TRUE, row.names = TRUE,append=TRUE)
```

